<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie...</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="dynamic-content-wrapper">
      <p style="text-align:center; padding-top: 50px;">≈Åadowanie...</p>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const sectionName = (params.get('nazwa') || '').trim();
    const wrapper = document.getElementById('dynamic-content-wrapper');

    document.documentElement.className = '';

    function createLector(buttonId, textElementId, buttonText = "Ods≈Çuchaj") {
        const btn = document.getElementById(buttonId);
        if (!btn) return;
        const textElement = document.getElementById(textElementId);
        if (!textElement) return;
        
        const fullText = (textElement.textContent || textElement.innerText || "").trim();
        if (!fullText) {
            btn.disabled = true;
            btn.style.opacity = 0.5;
            return;
        }

        const sentences = fullText.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [fullText];
        let currentIndex = 0;
        let isReading = false;

        function readSentence(i) {
            if (!isReading || i >= sentences.length) {
                window.speechSynthesis.cancel();
                isReading = false;
                btn.textContent = `‚ñ∂Ô∏è ${buttonText}`;
                currentIndex = 0;
                return;
            }
            const utterance = new SpeechSynthesisUtterance(sentences[i].trim());
            utterance.lang = "pl-PL";
            utterance.onend = () => { if (isReading) { currentIndex++; readSentence(currentIndex); } };
            window.speechSynthesis.speak(utterance);
        }

        btn.addEventListener("click", () => {
            const synth = window.speechSynthesis;
            if (isReading) {
                isReading = false;
                synth.cancel();
                btn.textContent = `üîÑ Wzn√≥w`;
            } else {
                isReading = true;
                btn.textContent = `‚è∏Ô∏è Pauza`;
                readSentence(currentIndex);
            }
        });
        window.addEventListener("beforeunload", () => window.speechSynthesis.cancel());
    }

    (async () => {
      try {
        if (!sectionName) {
          wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd</h1></header><main><div class="story-container">Brak nazwy sekcji w adresie URL.</div></main>`;
          return;
        }

        let themeClass = 'theme-kronika'; 
        if (sectionName === 'Piciorys Chudego') { themeClass = 'theme-piciorys'; } 
        else if (sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) { themeClass = 'theme-ksiezniczka'; } 
        else if (sectionName === 'Pomoc') { themeClass = 'theme-pomoc'; }
        else if (sectionName === 'Galeria') { themeClass = 'theme-galeria'; }
        document.documentElement.className = themeClass;

        document.title = `${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;
        const entriesRef = collection(db, 'sekcje', sectionName, 'entries');
        
        if (sectionName === 'Galeria') {
            const snap = await getDocs(query(entriesRef, orderBy("createdAt", "desc")));
            let items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let gridHTML = items.map((item, index) => `
                <div class="photo-card" data-index="${index}" role="button" tabindex="0" aria-label="Otw√≥rz: ${item.title || ''}">
                ${item.type === "video" 
                    ? `<div class="video-thumb" style="height: 220px; display: flex; align-items: center; justify-content: center; background: #000; font-size: 3em;">üé•</div>`
                    : `<img src="${item.url}" alt="${item.title || 'Zdjƒôcie'}">`}
                <div class="caption">
                    <h3>${item.title || 'Bez tytu≈Çu'}</h3>
                    <p>${item.text || ''}</p>
                </div>
                </div>
            `).join('');

            wrapper.innerHTML = `
                <header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
                <main><div class="grid-container"><div class="photo-grid">${gridHTML || '<p style="text-align:center;">Galeria jest pusta.</p>'}</div></div>
                <div id="lightbox" class="lightbox">
                    <div class="lb-inner">
                        <button id="lbClose" class="lb-close" aria-label="Zamknij">&times;</button>
                        <button id="lbPrev" class="lb-nav lb-prev">‚ùÆ</button>
                        <div id="lbMedia"></div>
                        <button id="lbNext" class="lb-nav lb-next">‚ùØ</button>
                        <div id="lbDesc" class="lb-desc"></div>
                    </div>
                </div>
                </main>`;

            const lightbox = document.getElementById('lightbox');
            const lbMedia = document.getElementById('lbMedia');
            const lbDesc = document.getElementById('lbDesc');
            let currentIndex = -1;

            function showItem(index) {
                if (index < 0) index = items.length - 1;
                if (index >= items.length) index = 0;
                currentIndex = index;
                let item = items[index];

                if (item.type === "video") {
                    lbMedia.innerHTML = `<video src="${item.url}" controls autoplay style="max-width: 90vw; max-height: 80vh; border-radius: 5px;"></video>`;
                } else {
                    lbMedia.innerHTML = `<img src="${item.url}" alt="${item.title}" style="max-width: 90vw; max-height: 80vh; border-radius: 5px;">`;
                }

                lbDesc.textContent = item.text || '';
                lightbox.classList.add('active');
            }
            
            document.querySelectorAll('.photo-card').forEach(card => {
                card.addEventListener('click', () => showItem(parseInt(card.dataset.index, 10)));
            });
            
            function closeLightbox() {
                lightbox.classList.remove('active');
                lbMedia.innerHTML = '';
            }

            document.getElementById('lbClose').addEventListener('click', closeLightbox);
            document.getElementById('lbPrev').addEventListener('click', () => showItem(currentIndex - 1));
            document.getElementById('lbNext').addEventListener('click', () => showItem(currentIndex + 1));
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) closeLightbox(); });
            window.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('active')) return;
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") showItem(currentIndex - 1);
            if (e.key === "ArrowRight") showItem(currentIndex + 1);
            });
        }
        else if (sectionName === 'Piciorys Chudego' || sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) {
            const snap = await getDocs(query(entriesRef, limit(1)));
            if (snap.empty) { wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container"><div class="story-item"><p>Brak wpisu w tej sekcji.</p></div></div></main>`; return; }
            const entry = snap.docs[0].data();
            
            if (sectionName === 'Piciorys Chudego') {
                const [quote, historia] = (entry.text || '').split('---PODZIAL---');
                wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><article class="newspaper-article"><div id="piciorys-wstep"><div class="newspaper-headline-wrapper"><h2 class="newspaper-headline">${entry.title || ''}</h2><div class="newspaper-headline-quote">${quote || ''}</div></div></div><div class="speak-button-container"><button id="speakBtn1" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Wstƒôp</button></div><div id="piciorys-historia" class="newspaper-text-content">${historia || ''}</div><div class="speak-button-container"><button id="speakBtn2" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Historiƒô</button></div></article></main>`;
                createLector("speakBtn1", "piciorys-wstep", "Ods≈Çuchaj Wstƒôp");
                createLector("speakBtn2", "piciorys-historia", "Ods≈Çuchaj Historiƒô");
            } else { // Ksiƒô≈ºniczka
                wrapper.innerHTML = `<div class="magic-background"><div id="stars1"></div><div id="stars2"></div><div id="stars3"></div></div><header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="content-wrapper"><div class="story-box"><div id="ksiezniczka-text"><h2>${entry.title || ''}</h2>${entry.text || ''}</div><div class="speak-button-container"><button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button></div></div></div></main>`;
                createLector("speakBtn", "ksiezniczka-text");
            }
        } 
        else if (sectionName === 'Pomoc') {
            const snap = await getDocs(query(entriesRef, orderBy('woj'), orderBy('title')));
        
            const groupedByWoj = snap.docs.reduce((acc, doc) => {
                const entry = doc.data();
                const woj = entry.woj || 'Inne';
                if (!acc[woj]) { acc[woj] = []; }
                acc[woj].push(entry);
                return acc;
            }, {});

            const wojOrder = ['Og√≥lnopolskie', ...Object.keys(groupedByWoj).filter(w => w !== 'Og√≥lnopolskie').sort()];
            let accordionsHTML = '';

            for (const woj of wojOrder) {
                if (groupedByWoj[woj]) {
                    const entriesHTML = groupedByWoj[woj].map(e => `
                        <div class="place-entry">
                            <h3>${e.title || 'Brak nazwy'}</h3>
                            <div>${e.text || 'Brak opisu.'}</div>
                        </div>
                    `).join('');

                    const icon = woj === 'Og√≥lnopolskie' ? 'üìû' : 'üè•';
                    accordionsHTML += `
                        <div class="woj-group" data-woj="${woj}">
                            <button class="accordion">${icon} ${woj}</button>
                            <div class="panel">${entriesHTML}</div>
                        </div>
                    `;
                }
            }
            
            wrapper.innerHTML = `
            <header class="page-header"><h1>Gdzie szukaƒá pomocy ‚Äì Uzale≈ºnienia</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
            <main><div class="container">
                <div class="filter-bar">
                    <label for="wojewodztwoSelect"><strong>Filtruj wg wojew√≥dztwa:</strong></label>
                    <select id="wojewodztwoSelect">
                        <option value="all">Wszystkie</option>
                        ${wojOrder.map(w => `<option value="${w}">${w}</option>`).join('')}
                    </select>
                </div>
                ${accordionsHTML || '<p>Brak o≈õrodk√≥w w bazie danych.</p>'}
            </div></main>`;
            
            document.querySelectorAll('.accordion').forEach(acc => {
            acc.addEventListener('click', function() {
                this.classList.toggle('active');
                const panel = this.nextElementSibling;
                panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
            });
            });

            const select = document.getElementById('wojewodztwoSelect');
            const wojGroups = document.querySelectorAll('.woj-group');
            select.addEventListener('change', function() {
                wojGroups.forEach(group => {
                    group.style.display = (this.value === 'all' || group.dataset.woj === this.value) ? 'block' : 'none';
                });
            });
        }
        else { 
            const snap = await getDocs(query(entriesRef, orderBy("createdAt", "desc")));
            let entriesHTML = '';
            if (snap.empty) {
                entriesHTML = `<div class="story-item"><p>Brak wpis√≥w w tej sekcji.</p></div>`;
            } else if (snap.docs.length === 1 && sectionName !== 'Kronika') {
                const doc = snap.docs[0];
                const e = doc.data();
                const contentId = `content-${doc.id}`;
                const buttonId = `button-${doc.id}`;
                entriesHTML = `
                    <div class="story-item">
                        <div id="${contentId}">
                            <h2>${e.title || ''}</h2>
                            <div class="entry-content">${e.text || ''}</div>
                        </div>
                        <div class="speak-button-container">
                            <button id="${buttonId}" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                        </div>
                    </div>`;
                setTimeout(() => createLector(buttonId, contentId), 0);
            } else {
                entriesHTML = snap.docs.map(doc => {
                const e = doc.data();
                const excerpt = e.text.replace(/<[^>]*>?/gm, '').substring(0, 250) + '...';
                const link = `Wpis.html?section=${encodeURIComponent(sectionName)}&id=${doc.id}`;
                return `<div class="story-item"><h2><a href="${link}">${e.title || 'Bez tytu≈Çu'}</a></h2><div class="entry-item-meta">${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : ''}</div><p>${excerpt}</p></div>`;
                }).join('');
            }
            wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container">${entriesHTML}</div></main>`;
        }
      } catch (err) {
        console.error("B≈ÇƒÖd krytyczny w Sekcja.html:", err);
        wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd krytyczny</h1></header><main><div class="story-container"><p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania strony. Sprawd≈∫ konsolƒô (F12), aby zobaczyƒá szczeg√≥≈Çy.</p></div></main>`;
      }
    })();
  </script>
</body>
</html>
