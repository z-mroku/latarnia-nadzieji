<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wpis ‚Äî Od Dna do ≈öwiat≈Ça</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <button class="theme-toggle" id="themeToggle" style="position: fixed; top: 10px; right: 10px; z-index: 100;">üåô</button>
  <div id="entry-wrapper">
    <p style="text-align:center; padding-top: 50px;">≈Åadowanie wpisu...</p>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { doc, getDoc, updateDoc, increment, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const sectionName = (params.get("section") || "").trim();
    const entryId = (params.get("id") || "").trim();
    const wrapper = document.getElementById("entry-wrapper");

    // Logika motywu
    let themeClass = 'theme-kronika';
    if (sectionName === 'Piciorys Chudego') themeClass = 'theme-piciorys'; 
    else if (sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) themeClass = 'theme-ksiezniczka'; 
    else if (sectionName === 'Pomoc') themeClass = 'theme-pomoc'; 
    document.documentElement.className = themeClass;

    // Logika trybu Ciemny/Jasny
    const themeToggle = document.getElementById("themeToggle");
    const currentTheme = localStorage.getItem("theme");
    if (currentTheme === "dark") {
        document.body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
    }
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      let theme = "light";
      if (document.body.classList.contains("dark")) {
        theme = "dark";
        themeToggle.textContent = "‚òÄÔ∏è";
      } else {
        themeToggle.textContent = "üåô";
      }
      localStorage.setItem("theme", theme);
    });

    function createLector(btnId, textId) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const el = document.getElementById(textId);
        if (!el) return;
        const text = el.innerText || "";
        const synth = window.speechSynthesis;
        let utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "pl-PL";

        btn.addEventListener("click", () => {
            if (synth.speaking) {
                synth.cancel();
            } else {
                synth.speak(utterance);
            }
        });
    }

    async function loadEntry() {
      if (!sectionName || !entryId) {
        wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd</h1></header><main><div class="story-container"><p>Brak wymaganych parametr√≥w (sekcja lub ID wpisu) w adresie URL.</p></div></main>`;
        return;
      }

      const ref = doc(db, "sekcje", sectionName, "entries", entryId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        wrapper.innerHTML = `<header class="page-header"><h1>Nie znaleziono</h1></header><main><div class="story-container"><p>Wpis o podanym ID nie istnieje w tej sekcji.</p></div></main>`;
        return;
      }
      const e = snap.data();

      await updateDoc(ref, { views: increment(1) }).catch(console.error);
      document.title = `${e.title || "Wpis"} ‚Äî Od Dna do ≈öwiat≈Ça`;
      
      wrapper.innerHTML = `
        <header class="page-header">
          <h1>${sectionName}</h1>
          <a href="sekcja.html?nazwa=${encodeURIComponent(sectionName)}" class="back-to-home-button">‚üµ Powr√≥t do sekcji</a>
        </header>
        <main>
          <div class="story-container">
            <article class="entry-content">
              <h2>${e.title || "Bez tytu≈Çu"}</h2>
              <div class="entry-meta">Autor: ${e.author || 'Anonim'} ‚Ä¢ Opublikowano: ${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : ''}</div>
              <div id="entry-text">${e.text || ""}</div>
              <div class="speak-button-container">
                <button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button>
              </div>
              <p style="text-align: right; font-size: 0.9em; color: #888; opacity: 0.7;">üëÅÔ∏è Wy≈õwietlenia: ${(e.views || 0) + 1}</p>
              <div class="nav-buttons" style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(128,128,128,0.2);">
                <button id="prevBtn" class="speak-button">‚üµ Poprzedni</button>
                <button id="nextBtn" class="speak-button">Nastƒôpny ‚ü∂</button>
              </div>
            </article>
          </div>
          <section id="comments" class="comments-section">
              <h2>Podziel siƒô swojƒÖ historiƒÖ lub wesprzyj innych</h2>
              <div id="disqus_thread"></div>
          </section>
        </main>`;

      createLector("speakBtn", "entry-text");
      
      // Logika Disqus
      (function() {
        var disqus_config = function () {
            this.page.url = window.location.href;
            this.page.identifier = entryId;
        };
        var d = document, s = d.createElement('script');
        s.src = `https://od-dna-do-swiatla.disqus.com/embed.js`;
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();

      // Logika nawigacji Poprzedni/Nastƒôpny
      const q = query(collection(db, "sekcje", sectionName, "entries"), orderBy("createdAt", "desc"));
      const docs = await getDocs(q);
      let ids = docs.docs.map(d => d.id);
      let pos = ids.indexOf(entryId);
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      if (pos > 0) {
        prevBtn.onclick = () => location.href = `wpis.html?section=${encodeURIComponent(sectionName)}&id=${ids[pos-1]}`;
      } else { prevBtn.style.visibility = 'hidden'; }
      if (pos < ids.length - 1 && pos !== -1) {
        nextBtn.onclick = () => location.href = `wpis.html?section=${encodeURIComponent(sectionName)}&id=${ids[pos+1]}`;
      } else { nextBtn.style.visibility = 'hidden'; }
    }
    loadEntry();
  </script>
</body>
</html>
