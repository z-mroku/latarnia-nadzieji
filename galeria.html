
<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galeria</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer"/>

<style>
/* Zmienne CSS dla kolorów i stylów */
:root{
  --bg1:#0e0f1b;
  --bg2:#151a2e;
  --bg3:#1d253e;
  --card:#121420;
  --cardEdge:#2a2f4a;
  --accent:#ff4c4c;
  --accent2:#ff9800;
}

html, body {height:100%; margin:0; font-family:'Lato', sans-serif; color:#fff;}

/* Globalne tło strony */
body{
  background:
    radial-gradient(1200px 600px at 10% -10%, #22294a 0%, transparent 60%),
    radial-gradient(900px 600px at 110% 10%, #1a1f38 0%, transparent 60%),
    linear-gradient(160deg, var(--bg1), var(--bg2) 50%, var(--bg3));
  overflow-x:hidden;
}

/* Główne opakowanie dla zawartości galerii */
.wrap{ max-width:1400px; margin:0 auto; padding:28px 18px 36px; }

/* Górny pasek z przyciskiem powrotu i tytułem */
.topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }

/* Przycisk "Powrót" */
.back-btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:10px 14px; font-weight:700; letter-spacing:.3px;
  border-radius:999px; border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.25); color:#fff; text-decoration:none;
  transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
  box-shadow: 0 4px 18px rgba(0,0,0,.25);
}
.back-btn:hover{ border-color:#ffffff3a; box-shadow:0 8px 28px rgba(0,0,0,.35)}
.back-btn:active{ transform: translateY(1px) }

/* Tytuł galerii */
.title{ flex:1; text-align:center; }
.title h1{
  margin:6px 0 2px; font-size: clamp(42px, 7vw, 92px); line-height:1.05; font-weight:900; letter-spacing:2px;
  display:inline-block; padding:0 .15em; background: linear-gradient(160deg, #fff, #cfd3e6, #888a9d, var(--bg2));
  -webkit-background-clip: text; background-clip: text; color: transparent;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.6), -2px -2px 4px rgba(255,255,255,0.1);
  transform: perspective(700px) rotateX(12deg) rotateY(-6deg);
}

/* Podtytuł galerii */
.subtitle{
  font-size: clamp(20px, 4vw, 38px); font-weight:700; margin-top:12px;
  background: linear-gradient(120deg, #ddd, #aaa, var(--bg3));
  -webkit-background-clip: text; background-clip: text; color: transparent;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.5), -1px -1px 3px rgba(255,255,255,0.1);
  transform: perspective(600px) rotateX(8deg) rotateY(5deg);
}

/* --- Sekcja Filtrów --- */
.filters {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin: 20px 0;
}
.filter-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ccc;
    padding: 8px 16px;
    border-radius: 999px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 700;
}
.filter-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}
.filter-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
    box-shadow: 0 0 15px rgba(255, 76, 76, 0.5);
}

/* --- Siatka zdjęć i poszczególne karty --- */
.grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:18px; margin-top:22px; }
.card{
    background: linear-gradient(180deg, #0e1120, #0f1324); border:1px solid var(--cardEdge);
    border-radius:14px; overflow:hidden; box-shadow: 0 8px 26px rgba(0,0,0,.35);
    cursor:pointer;
    opacity: 0; /* Początkowo niewidoczne do animacji */
    transform: translateY(20px); /* Początkowo przesunięte w dół do animacji */
    transition: opacity 0.4s ease-out, transform 0.4s ease-out, box-shadow .2s ease, border-color .2s ease;
    /* Dodatkowe przejścia dla filtrowania */
    position: relative; /* Ważne dla płynnego ukrywania/pokazywania */
}
.card.visible { opacity: 1; transform: translateY(0); } /* Stan widoczny */
.card.hidden { opacity: 0; transform: scale(0.8); pointer-events: none; } /* Stan ukryty przy filtrowaniu */

.card:hover{ transform: translateY(-2px); box-shadow: 0 16px 36px rgba(0,0,0,.45); border-color:#3a4268; }

.thumb-wrap{ width:100%; height:210px; background:#0a0d18; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.thumb{
    width: 100%; height: 100%; object-fit: cover;
    opacity: 0; /* Początkowo niewidoczne dla animacji ładowania obrazu */
    transition: opacity 0.5s ease;
}
.thumb.loaded { opacity: 1; } /* Stan po załadowaniu obrazu */

.cap{ padding:12px 12px 14px; text-align:center; }
.cap .t{ font-weight:700; color: var(--accent); text-shadow: 0 1px 0 #000, 0 8px 22px rgba(0,0,0,.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.empty{ text-align:center; color:#b9c2db; padding:24px 8px; border:1px dashed #2a3152; border-radius:12px; background: #0c1022b3; }

/* Szkielet ładowania (skeleton loader) */
.skeleton {
    background: linear-gradient(180deg, #0e1120, #0f1324);
    border: 1px solid var(--cardEdge);
    border-radius: 14px;
    overflow: hidden;
}
.skeleton .thumb-wrap, .skeleton .cap .t {
    background: linear-gradient(90deg, #151a2e 25%, #1d253e 50%, #151a2e 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite linear;
}
.skeleton .cap .t { height: 20px; width: 80%; margin: 0 auto; border-radius: 4px; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* --- Lightbox (pełnoekranowe wyświetlanie zdjęcia) --- */
.lightbox{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background: rgba(5,7,14,.86); backdrop-filter: blur(6px);
  z-index: 9999; opacity:0; transition: opacity .2s ease;
}
.lightbox.open{ display:flex; opacity:1 } /* Stan otwarty */
.lb-content-wrap { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.lb-media{
  display:block; max-width:90vw; max-height:80vh; margin:0 auto;
  border-radius:12px; box-shadow:0 12px 48px rgba(0,0,0,.6);
  background:#070a14; object-fit: contain;
}
.lb-caption {
  width: auto; max-width: 80vw; margin-top: 16px; padding: 12px 24px;
  background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; color: #eee; text-align: center; font-size: 1.1rem; font-weight: 700;
  text-shadow: 1px 1px 2px #000; backdrop-filter: blur(5px);
  opacity: 0; transition: opacity 0.3s ease 0.1s; /* Animacja pojawiania się opisu */
}
.lightbox.open .lb-caption { opacity: 1; }
.lb-btn {
  background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1);
  color:white; cursor:pointer; transition: background-color .2s, border-color .2s;
}
.lb-btn:hover { background:rgba(0,0,0,0.7); border-color: rgba(255,255,255,0.2); }
.lb-close{
  position:absolute; top:14px; right:16px; width:44px; height:44px; border-radius:50%;
  display:flex; align-items:center; justify-content:center; font-size:20px;
}
.lb-nav{
  position:absolute; top:50%; transform:translateY(-50%); width:48px; height:56px;
  border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px;
}
.lb-prev{ left:10px }
.lb-next{ right:10px }

/* Media Queries dla responsywności */
@media (max-width: 640px){ .thumb-wrap{ height:160px; } .lb-media{ max-height:70vh; } }
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <a class="back-btn" href="index.html" aria-label="Powrót">
      <i class="fa-solid fa-arrow-left"></i><span>Powrót</span>
    </a>
    <div class="title">
      <h1>Galeria</h1>
      <div class="subtitle">Chwile, które mnie zmieniły</div>
    </div>
    <div style="width:110px"></div>
  </div>

  <div id="gallery-filters" class="filters"></div>

  <div id="grid" class="grid" aria-live="polite" aria-busy="true"></div>
  <div id="empty" class="empty" style="display:none">Galeria jest pusta.</div>
</div>

<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-hidden="true">
  <button id="lbClose" class="lb-close lb-btn" aria-label="Zamknij"><i class="fa-solid fa-xmark"></i></button>
  <button id="lbPrev" class="lb-nav lb-prev lb-btn" aria-label="Poprzednie"><i class="fa-solid fa-chevron-left"></i></button>
  <button id="lbNext" class="lb-nav lb-next lb-btn" aria-label="Następne"><i class="fa-solid fa-chevron-right"></i></button>
  <div class="lb-content-wrap">
    <img id="lbImg" class="lb-media" src="" alt="Zdjęcie">
    <div id="lbCaption" class="lb-caption"></div>
  </div>
</div>

<script type="module">
// Konfiguracja Firebase (z poprawnym storageBucket)
const firebaseConfig = {
  apiKey: "AIzaSyD1kuonCrsLNV4ObBiI2jsqdnGx3vaA9_Q",
  authDomain: "projekt-latarnia.firebaseapp.com",
  projectId: "projekt-latarnia",
  storageBucket: "projekt-latarnia.firebasestorage.app", // ✅ POPRAWNY ADRES BUCKETU
  messagingSenderId: "244008044225",
  appId: "1:244008044225:web:67fbc7f5cfa89b627fb640",
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Pobieranie referencji do elementów DOM
const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const lightbox = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbClose = document.getElementById('lbClose');
const lbPrev = document.getElementById('lbPrev');
const lbNext = document.getElementById('lbNext');
const lbCaption = document.getElementById('lbCaption');
const galleryFilters = document.getElementById('gallery-filters');

let galleryItems = []; // Przechowuje wszystkie elementy galerii
let currentIdx = -1; // Aktualnie wyświetlany indeks w lightboxie

// Funkcja pomocnicza do escapowania HTML
function escapeHtml(s) { return String(s || '').replace(/[&<>"]'/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])); }

// Wyświetlanie szkieletów ładowania
function renderSkeletons(count) {
    grid.innerHTML = '';
    for (let i = 0; i < count; i++) {
        const skeleton = document.createElement('div');
        skeleton.className = 'skeleton';
        skeleton.innerHTML = `<div class="thumb-wrap"></div><div class="cap"><div class="t"></div></div>`;
        grid.appendChild(skeleton);
    }
}

// Renderowanie kart galerii
function renderGallery(items) {
    grid.innerHTML = ''; // Czyścimy siatkę
    if (items.length === 0) {
        empty.style.display = 'block'; // Pokaż komunikat o pustej galerii
        return;
    }
    empty.style.display = 'none';

    items.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'card'; // Początkowo bez klasy 'visible' dla animacji
        
        const thumbWrap = document.createElement('div');
        thumbWrap.className = 'thumb-wrap';

        const thumbImg = new Image();
        thumbImg.className = 'thumb';
        thumbImg.alt = escapeHtml(item.title);
        thumbImg.loading = 'lazy';

        // Animacja pojawiania się miniatury po załadowaniu
        thumbImg.onload = () => {
            thumbImg.classList.add('loaded');
        };
        thumbImg.src = escapeHtml(item.attachment?.url);

        thumbWrap.appendChild(thumbImg);
        
        const caption = document.createElement('div');
        caption.className = 'cap';
        caption.innerHTML = `<div class="t">${escapeHtml(item.title)}</div>`;

        card.appendChild(thumbWrap);
        card.appendChild(caption);

        card.addEventListener('click', () => openLightbox(idx));
        grid.appendChild(card);

        // Kaskadowa animacja pojawiania się kart
        setTimeout(() => {
            card.classList.add('visible');
        }, idx * 75); // Opóźnienie dla każdej kolejnej karty
    });
}

// Renderowanie przycisków filtrowania
function renderFilters(items) {
    const allTags = new Set(items.flatMap(item => item.tags || []).filter(Boolean)); // Upewnij się, że tagi istnieją
    galleryFilters.innerHTML = '';

    const allBtn = document.createElement('button');
    allBtn.className = 'filter-btn active';
    allBtn.textContent = 'Wszystkie';
    allBtn.dataset.tag = 'all';
    galleryFilters.appendChild(allBtn);

    allTags.forEach(tag => {
        const tagBtn = document.createElement('button');
        tagBtn.className = 'filter-btn';
        tagBtn.textContent = tag;
        tagBtn.dataset.tag = tag;
        galleryFilters.appendChild(tagBtn);
    });

    // Obsługa kliknięcia przycisków filtrowania
    galleryFilters.addEventListener('click', e => {
        if (e.target.classList.contains('filter-btn')) {
            const selectedTag = e.target.dataset.tag;
            
            // Usuń aktywną klasę ze wszystkich przycisków i dodaj do klikniętego
            galleryFilters.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            
            // Filtrowanie i animacja kart
            grid.querySelectorAll('.card').forEach((card, idx) => {
                const item = galleryItems[idx];
                const hasTag = item.tags && item.tags.includes(selectedTag);

                if (selectedTag === 'all' || hasTag) {
                    card.classList.remove('hidden'); // Pokaż kartę
                } else {
                    card.classList.add('hidden'); // Ukryj kartę
                }
            });
        }
    });
}

// Otwieranie lightboxa
function openLightbox(idx) {
    if (idx < 0 || idx >= galleryItems.length) return;
    currentIdx = idx;
    lbImg.src = escapeHtml(galleryItems[idx].attachment?.url);
    lbImg.alt = escapeHtml(galleryItems[idx].title);
    lbCaption.textContent = escapeHtml(galleryItems[idx].title);
    lightbox.classList.add('open');
    lightbox.setAttribute('aria-hidden', 'false');
}

// Zamykanie lightboxa
function closeLightbox() {
    lightbox.classList.remove('open');
    lightbox.setAttribute('aria-hidden', 'true');
    lbImg.src = ''; // Wyczyść src, aby zapobiec ponownemu ładowaniu
    lbCaption.textContent = '';
}

// Nawigacja w lightboxie (poprzednie zdjęcie)
function showPrev() {
    const newIndex = (currentIdx - 1 + galleryItems.length) % galleryItems.length;
    openLightbox(newIndex);
}

// Nawigacja w lightboxie (następne zdjęcie)
function showNext() {
    const newIndex = (currentIdx + 1) % galleryItems.length;
    openLightbox(newIndex);
}

// Główna funkcja ładowania danych galerii
async function loadGallery() {
    grid.setAttribute('aria-busy', 'true');
    renderSkeletons(8); // Pokaż szkielety podczas ładowania

    try {
        const gallerySectionName = 'Galeria';
        const entriesColl = collection(db, 'sekcje', gallerySectionName, 'entries');
        const q = query(entriesColl, orderBy('createdAt', 'desc')); // Upewnij się, że kolejność jest spójna
        const snap = await getDocs(q);
        galleryItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        renderGallery(galleryItems);
        renderFilters(galleryItems);
        
    } catch (err) {
        console.error('Błąd ładowania galerii:', err);
        empty.textContent = 'Nie udało się wczytać galerii.';
        grid.innerHTML = ''; // Wyczyść siatkę w razie błędu
    } finally {
        grid.setAttribute('aria-busy', 'false'); // Zakończ stan ładowania
    }
}

// Ustawienie globalnych słuchaczy zdarzeń
function setupEventListeners() {
    lbClose.addEventListener('click', closeLightbox);
    lbPrev.addEventListener('click', showPrev);
    lbNext.addEventListener('click', showNext);
    // Zamykanie lightboxa kliknięciem poza zdjęciem
    lightbox.addEventListener('click', e => { if (e.target === lightbox) closeLightbox(); });
    // Obsługa klawiszy w lightboxie
    window.addEventListener('keydown', (e) => {
        if (!lightbox.classList.contains('open')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNext();
        if (e.key === 'ArrowLeft') showPrev();
    });
}

// Inicjalizacja: ustawienie słuchaczy i załadowanie galerii
setupEventListeners();
loadGallery();
</script>
</body>
</html>

