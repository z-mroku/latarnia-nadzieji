<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wczytywanie...</title>
<link rel="stylesheet" href="/css/style.css" />
<script type="module">
import { db } from './js/firebase-config.js';
import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const sectionNameRaw = (params.get('nazwa')||params.get('section')||'').trim();
const sectionName = decodeURIComponent(sectionNameRaw);
const wrapper = document.getElementById('dynamic-content-wrapper');

// Lektor
function createLector(btnId, elId, text="Ods≈Çuchaj"){
    const btn=document.getElementById(btnId); if(!btn) return;
    const el=document.getElementById(elId); if(!el) {btn.disabled=true;return;}
    const fullText=(el.innerText||el.textContent||'').trim(); if(!fullText){btn.disabled=true;return;}
    const sentences=fullText.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g)||[fullText];
    let idx=0,isReading=false;
    btn.addEventListener('click',()=>{ 
        if(isReading){ isReading=false; window.speechSynthesis.cancel(); btn.textContent=`üîÑ Wzn√≥w`; }
        else{ isReading=true; btn.textContent=`‚è∏Ô∏è Pauza`; read(idx);}
    });
    function read(i){ 
        if(!isReading||i>=sentences.length){window.speechSynthesis.cancel(); isReading=false; btn.textContent=`‚ñ∂Ô∏è ${text}`; idx=0; return;}
        const u=new SpeechSynthesisUtterance(sentences[i]); u.lang="pl-PL"; u.onend=()=>{if(isReading){idx++;read(idx);}}; window.speechSynthesis.speak(u);
    }
}

// Render standard
async function renderStandard(){
    try{
        const snap=await getDocs(query(collection(db,'sekcje',sectionName,'entries'),orderBy('createdAt','desc')));
        if(snap.empty){ wrapper.innerHTML=`<header><h1>${sectionName}</h1></header><p>Brak wpis√≥w.</p>`; return;}
        const html = snap.docs.map(d=>{
            const e=d.data(),id=d.id,cId=`content-full-${id}`,bId=`button-speak-${id}`;
            const skrot=(e.text||'').replace(/<[^>]*>?/gm,'').substring(0,300);
            return `<div class="story-item">
                <h2>${e.title||'Bez tytu≈Çu'}</h2>
                <div class="entry-item-meta">${e.createdAt?e.createdAt.toDate().toLocaleDateString('pl-PL'):''}</div>
                <div class="wpis-skrot"><p>${skrot}...</p></div>
                <div id="${cId}" class="wpis-calosc" style="display:none;">${e.text||''}</div>
                <div class="speak-button-container">
                    <button class="czytaj-dalej-btn">...czytaj dalej</button>
                    <button id="${bId}" class="speak-button" style="display:none;">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                </div>
            </div>`;
        }).join('');
        wrapper.innerHTML=`<header><h1>${sectionName}</h1></header><main class="story-container">${html}</main>`;
        document.querySelectorAll('.czytaj-dalej-btn').forEach(btn=>{
            btn.addEventListener('click',function(){
                const item=this.closest('.story-item');
                const sk=item.querySelector('.wpis-skrot');
                const cal=item.querySelector('.wpis-calosc');
                const sp=item.querySelector('.speak-button');
                const open=cal.style.display==='block';
                if(open){ cal.style.display='none'; sp.style.display='none'; sk.style.display='block'; this.textContent='...czytaj dalej'; }
                else{ cal.style.display='block'; sp.style.display='inline-flex'; sk.style.display='none'; this.textContent='Zwi≈Ñ'; }
            });
        });
        snap.docs.forEach(d=>{ createLector(`button-speak-${d.id}`,`content-full-${d.id}`); });
    } catch(e){ console.error(e); wrapper.innerHTML="<p>B≈ÇƒÖd ≈Çadowania sekcji</p>"; }
}

// Start
document.addEventListener('DOMContentLoaded',()=>{ 
    if(!sectionName){ wrapper.innerHTML="<p>Brak nazwy sekcji w URL.</p>"; return;}
    renderStandard();
});
</script>
</head>
<body>
<a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a>
<div id="dynamic-content-wrapper" style="padding-top:50px;text-align:center;">≈Åadowanie...</div>
</body>
</html>
