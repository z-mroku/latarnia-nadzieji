<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie...</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="dynamic-content-wrapper">
      <p style="text-align:center; padding-top: 50px;">≈Åadowanie...</p>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const sectionName = (params.get('nazwa') || '').trim();
    const wrapper = document.getElementById('dynamic-content-wrapper');

    // --- LOGIKA MOTYW√ìW ---
    function applyTheme(sectionName) {
        document.documentElement.className = ''; // Reset
        let themeClass = 'theme-kronika'; 
        if (sectionName === 'Piciorys Chudego') themeClass = 'theme-piciorys'; 
        else if (sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) themeClass = 'theme-ksiezniczka'; 
        else if (sectionName === 'Pomoc') themeClass = 'theme-pomoc'; 
        else if (sectionName === 'Galeria') themeClass = 'theme-galeria';
        document.documentElement.className = themeClass;
    }

    // --- LOGIKA LEKTORA ---
    function createLector(buttonId, textElementId) {
        const btn = document.getElementById(buttonId);
        const textElement = document.getElementById(textElementId);
        if (!btn || !textElement) return;
        
        const textToRead = (textElement.textContent || textElement.innerText || "").trim();
        if (!textToRead) {
            btn.style.display = 'none';
            return;
        }

        const synth = window.speechSynthesis;
        let utterance = new SpeechSynthesisUtterance(textToRead);
        utterance.lang = "pl-PL";

        btn.addEventListener("click", () => {
            if (synth.speaking) {
                synth.cancel();
            } else {
                synth.speak(utterance);
            }
        });

        // Reset lektora przy zmianie stanu
        utterance.onend = () => { btn.textContent = '‚ñ∂Ô∏è Ods≈Çuchaj'; };
        synth.onvoiceschanged = () => synth.cancel();
    }
    
    // --- RENDEROWANIE SEKCJI "POMOC" ---
    async function renderHelpSection() {
        applyTheme('Pomoc');
        document.title = `Pomoc ‚Äî Od Dna do ≈öwiat≈Ça`;
        const helpCollectionRef = collection(db, 'help');
        const snap = await getDocs(query(helpCollectionRef, orderBy("woj")));
    
        const groupedByWoj = snap.docs.reduce((acc, doc) => {
            const entry = doc.data();
            const woj = entry.woj || 'Inne';
            if (!acc[woj]) { acc[woj] = []; }
            acc[woj].push(entry);
            return acc;
        }, {});

        const wojOrder = ['Og√≥lnopolskie', ...Object.keys(groupedByWoj).filter(w => w !== 'Og√≥lnopolskie').sort()];
        let accordionsHTML = '';

        for (const woj of wojOrder) {
            if (groupedByWoj[woj]) {
                const entriesHTML = groupedByWoj[woj].map(e => `
                    <div class="place-entry">
                        <h3>${e.name || 'Brak nazwy'}</h3>
                        ${e.address ? `<p><strong>Adres:</strong> ${e.address}</p>` : ''}
                        ${e.phone ? `<p><strong>Telefon:</strong> ${e.phone}</p>` : ''}
                        ${e.desc ? `<p>${e.desc}</p>` : ''}
                        ${e.link ? `<p><a href="${e.link}" target="_blank" rel="noopener">Przejd≈∫ do strony</a></p>` : ''}
                    </div>`
                ).join('');
                const icon = woj === 'Og√≥lnopolskie' ? 'üìû' : 'üè•';
                accordionsHTML += `<button class="accordion">${icon} ${woj}</button><div class="panel">${entriesHTML}</div>`;
            }
        }
        
        wrapper.innerHTML = `
        <header class="page-header"><h1>Gdzie szukaƒá pomocy</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
        <main><div class="container">${accordionsHTML || '<p>Brak o≈õrodk√≥w w bazie danych.</p>'}</div></main>`;
        
        document.querySelectorAll('.accordion').forEach(acc => {
            acc.addEventListener('click', function() {
                this.classList.toggle('active');
                const panel = this.nextElementSibling;
                panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
            });
        });
    }

    // --- RENDEROWANIE POJEDYNCZYCH WPIS√ìW (PICIORYS, KSIƒò≈ªNICZKA) ---
    async function renderSingleEntrySection(sectionName, entriesRef) {
        applyTheme(sectionName);
        document.title = `${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;
        const snap = await getDocs(query(entriesRef, limit(1)));
        if (snap.empty) {
            wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container"><p>Brak wpisu w tej sekcji.</p></div></main>`;
            return;
        }
        const entry = snap.docs[0].data();
        
        let contentHTML = '';
        if (sectionName === 'Piciorys Chudego') {
            const [quote, historia] = (entry.text || '').split('---PODZIAL---');
            contentHTML = `<article class="newspaper-article"><div id="piciorys-text"><div class="newspaper-headline-wrapper"><h2 class="newspaper-headline">${entry.title || ''}</h2><div class="newspaper-headline-quote">${quote || ''}</div></div><div class="newspaper-text-content">${historia || ''}</div></div><div class="speak-button-container"><button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button></div></article>`;
        } else { // Ksiƒô≈ºniczka
            contentHTML = `<div class="magic-background"><div id="stars1"></div><div id="stars2"></div><div id="stars3"></div></div><div class="story-box"><div id="story-text"><h2>${entry.title || ''}</h2>${entry.text || ''}</div><div class="speak-button-container"><button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button></div></div>`;
        }
        
        wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main>${contentHTML}</main>`;
        createLector("speakBtn", sectionName === 'Piciorys Chudego' ? "piciorys-text" : "story-text");
    }

    // --- RENDEROWANIE LISTY WPIS√ìW (KRONIKA, OPOWIE≈öCI) ---
    async function renderEntriesList(sectionName, entriesRef) {
        applyTheme(sectionName);
        document.title = `${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;
        
        // ZMIANA: Sortowanie dla Kroniki
        const sortOrder = sectionName === 'Kronika' ? 'asc' : 'desc';
        const snap = await getDocs(query(entriesRef, orderBy("createdAt", sortOrder)));
        
        let entriesHTML = '';
        if (snap.empty) {
            entriesHTML = `<div class="story-item"><p>Brak wpis√≥w w tej sekcji.</p></div>`;
        } else {
            entriesHTML = snap.docs.map(doc => {
                const e = doc.data();
                const url = `wpis.html?section=${encodeURIComponent(sectionName)}&id=${doc.id}`;
                const skrot = e.text.replace(/<[^>]*>?/gm, '').substring(0, 300);
                return `
                    <div class="story-item">
                        <h2><a href="${url}">${e.title || 'Bez tytu≈Çu'}</a></h2>
                        <div class="entry-item-meta">${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : ''}</div>
                        <p>${skrot}...</p>
                        <a href="${url}" class="speak-button" style="text-decoration: none;">Czytaj dalej</a>
                    </div>`;
            }).join('');
        }
        wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container">${entriesHTML}</div></main>`;
    }


    // --- G≈Å√ìWNY PUNKT WEJ≈öCIA ---
    (async () => {
      try {
        if (!sectionName) {
            wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd</h1></header><main><div class="story-container">Brak nazwy sekcji w adresie URL.</div></main>`;
            return;
        }

        if (sectionName === 'Pomoc') {
            await renderHelpSection();
        } else {
            const entriesRef = collection(db, 'sekcje', sectionName, 'entries');
            if (sectionName === 'Piciorys Chudego' || sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) {
                await renderSingleEntrySection(sectionName, entriesRef);
            } else {
                await renderEntriesList(sectionName, entriesRef);
            }
        }
      } catch (err) {
        console.error("B≈ÇƒÖd krytyczny w sekcja.html:", err);
        wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd krytyczny</h1></header><main><div class="story-container"><p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania strony. Sprawd≈∫ konsolƒô (F12).</p></div></main>`;
      }
    })();
  </script>
</body>
</html>
