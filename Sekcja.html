
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie sekcji...</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 100px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .full-content { margin-top: 1em; border-left: 3px solid rgba(255,255,255,0.2); padding-left: 1em; }
  </style>
</head>
<body>
  <a href="/index.html" class="action-button" style="position: fixed; top: 15px; left: 15px; z-index: 1001;">
      <i class="fas fa-arrow-left"></i> Powrót
  </a>
  
  <div id="content-wrapper">
    <div class="loading-spinner"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, limit, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD1kuonCrsLNV4ObBiI2jsqdnGx3vaA9_Q",
      authDomain: "projekt-latarnia.firebaseapp.app",
      projectId: "projekt-latarnia",
      storageBucket: "projekt-latarnia.firebasestorage.app", // POPRAWIONY ADRES
      messagingSenderId: "244008044225",
      appId: "1:244008044225:web:67fbc7f5cfa89b627fb640",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lektor = (() => {
        let queue = []; let currentUtterance = null; let isPaused = false; let selectedVoice = null; const stripHtml = (html = "") => { const div = document.createElement("div"); div.innerHTML = html; return div.textContent || div.innerText || ""; }; const numToWords = (num) => { if (num > 999999) return num.toString(); const ones = ["zero","jeden","dwa","trzy","cztery","pięć","sześć","siedem","osiem","dziewięć"]; const teens = ["dziesięć","jedenaście","dwanaście","trzynaście","czternaście","piętnaście","szesnaście","siedemnaście","osiemnaście","dziewiętnaście"]; const tens = ["","dziesięć","dwadzieścia","trzydzieści","czterdzieści","pięćdziesiąt","sześćdziesiąt","siedemdziesiąt","osiemdziesiąt","dziewięćdziesiąt"]; const hundreds = ["","sto","dwieście","trzysta","czterysta","pięćset","sześćset","siedemset","osiemset","dziewięćset"]; if (num < 10) return ones[num]; if (num < 20) return teens[num-10]; if (num < 100) return tens[Math.floor(num/10)] + (num%10 ? " " + ones[num%10] : ""); if (num < 1000) return hundreds[Math.floor(num/100)] + (num%100 ? " " + numToWords(num%100) : ""); if (num < 2000) return "tysiąc " + (num%1000 ? numToWords(num%1000) : ""); const thousands = Math.floor(num/1000); let thousandsStr = ""; if ([2,3,4].includes(thousands % 10) && ![12,13,14].includes(thousands % 100)) thousandsStr = numToWords(thousands) + " tysiące"; else thousandsStr = numToWords(thousands) + " tysięcy"; return thousandsStr + (num%1000 ? " " + numToWords(num%1000) : ""); }; const parseDate = (str) => { const match = str.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/); if (!match) return null; const [_, d, m, y] = match.map(Number); const months = ["","stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","września","października","listopada","grudnia"]; return `${numToWords(d)} ${months[m]} ${numToWords(y)} roku`; }; const parseTime = (str) => { const match = str.match(/^(\d{1,2}):(\d{2})$/); if (!match) return null; const [_, h, m] = match.map(Number); if (m === 0) return `${numToWords(h)} zero zero`; return `${numToWords(h)} ${numToWords(m)}`; }; const normalizeText = (input = "") => { let text = stripHtml(input); const replacements = { "np.": "na przykład", "itd.": "i tak dalej", "itp.": "i tym podobne", "m.in.": "między innymi", "tj.": "to jest", "dr ": "doktor ", "prof.": "profesor", "ul.": "ulica", "mr ": "mister ", "mrs ": "missis " }; for (const [abbr, full] of Object.entries(replacements)) { text = text.replace(new RegExp("\\b" + abbr.replace(".", "\\.") + "\\b", "gi"), full); } const emojiMap = { "🙂": "uśmiech","😀": "szeroki uśmiech","😂": "śmiech","❤️": "serce","👍": "kciuk w górę" }; for (const [emoji, word] of Object.entries(emojiMap)) text = text.replaceAll(emoji, " " + word + " "); text = text.replace(/\b\d{1,2}\.\d{1,2}\.\d{4}\b/g, (d) => parseDate(d) || d); text = text.replace(/\b\d{1,2}:\d{2}\b/g, (t) => parseTime(t) || t); text = text.replace(/\b\d+\b/g, (n) => { const num = parseInt(n, 10); return isNaN(num) ? n : numToWords(num); }); return text.replace(/\s+/g, " ").trim(); }; const splitText = (text, maxLen = 250) => { const parts = []; if (!text) return parts; const sentences = text.match(/[^.!?]+[.!?]*/g) || []; let chunk = ""; for (const s of sentences) { if ((chunk + " " + s).length > maxLen) { if (chunk) parts.push(chunk.trim()); chunk = s; } else { chunk += " " + s; } } if (chunk.trim()) parts.push(chunk.trim()); return parts.filter(p => p); }; const pickVoice = () => { const voices = window.speechSynthesis.getVoices(); if (!voices || voices.length === 0) return null; const polishVoice = voices.find(v => v.name === "Microsoft Adam - Polish (Poland)" || v.lang === "pl-PL"); return polishVoice || voices.find(v => v.lang && v.lang.startsWith("pl")) || voices[0]; }; const initVoices = () => { selectedVoice = pickVoice(); }; window.speechSynthesis.onvoiceschanged = initVoices; initVoices(); const speakNext = () => { if (isPaused || queue.length === 0) { currentUtterance = null; return; } const text = queue.shift(); currentUtterance = new SpeechSynthesisUtterance(text); currentUtterance.lang = "pl-PL"; if (selectedVoice) currentUtterance.voice = selectedVoice; currentUtterance.rate = 0.9; currentUtterance.onend = () => { currentUtterance = null; if (!isPaused) speakNext(); }; currentUtterance.onerror = (e) => { console.error("❌ Błąd lektora:", e); currentUtterance = null; speakNext(); }; window.speechSynthesis.speak(currentUtterance); }; const enqueue = (rawText) => { if (!rawText) return; stop(); const clean = normalizeText(rawText); const parts = splitText(clean); queue.push(...parts); if (!window.speechSynthesis.speaking) { isPaused = false; speakNext(); } }; const stop = () => { isPaused = false; queue = []; window.speechSynthesis.cancel(); currentUtterance = null; }; const pause = () => { if (window.speechSynthesis.speaking && !isPaused) { window.speechSynthesis.pause(); isPaused = true; } }; const resume = () => { if (window.speechSynthesis.paused && isPaused) { window.speechSynthesis.resume(); isPaused = false; } }; const getStatus = () => ({ speaking: window.speechSynthesis.speaking, paused: isPaused }); return { enqueue, stop, pause, resume, getStatus };
    })();
    
    const SectionLoader = {
        state: { sectionName: '', currentLectorTarget: null },
        elements: { wrapper: document.getElementById('content-wrapper') },
        utils: {
            escapeHtml: (s = '') => String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])),
            stripHtml: (s = '') => String(s).replace(/<[^>]*>?/gm, ''),
        },
        router: {
            'Piciorys Chudego': { fetcher: 'fetchSingleEntry', renderer: 'renderPiciorys', theme: 'theme-piciorys' },
            'Z punktu widzenia księżniczki': { fetcher: 'fetchSingleEntry', renderer: 'renderKsiezniczka', theme: 'theme-ksiezniczka' },
            'Pomoc': { fetcher: 'fetchAllHelpEntries', renderer: 'renderPomoc', theme: 'theme-pomoc' },
            'List w Butelce': { fetcher: 'fetchNoOp', renderer: 'renderBottleSection', theme: 'theme-bottle' },
            'Galeria': { fetcher: 'fetchNoOp', renderer: 'renderGallery', theme: 'theme-gallery' },
            '__default__': { fetcher: 'fetchAllEntries', renderer: 'renderStandard', queryOptions: [orderBy('createdAt', 'desc')], theme: 'theme-kronika' }
        },

        async init() {
            this.setupEventListeners();
            try {
                const params = new URLSearchParams(window.location.search);
                this.state.sectionName = decodeURIComponent(params.get('nazwa') || 'Kronika').trim();
                const routeConfig = this.router[this.state.sectionName] || this.router['__default__'];
                document.documentElement.className = routeConfig.theme;
                document.title = `${this.utils.escapeHtml(this.state.sectionName)} — Od Dna do Światła`;
                const data = await this.fetch[routeConfig.fetcher](routeConfig.queryOptions);
                this.render[routeConfig.renderer](data);
            } catch (error) {
                console.error('Błąd krytyczny w SectionLoader:', error);
                this.render.renderError.call(this, 'Błąd Krytyczny', 'Wystąpił problem z ładowaniem sekcji.');
            }
        },

        setupEventListeners() {
            this.elements.wrapper.addEventListener('click', async (event) => {
                const button = event.target.closest('[data-action]');
                if (!button) return;
                const action = button.dataset.action;
                if (action === 'lector-play-pause') { const targetId = button.dataset.target; const lectorStatus = lektor.getStatus(); if (lectorStatus.speaking && !lectorStatus.paused && this.state.currentLectorTarget === targetId) { lektor.pause(); button.innerHTML = `<i class="fas fa-play"></i> Wznów`; } else if (lectorStatus.paused && this.state.currentLectorTarget === targetId) { lektor.resume(); button.innerHTML = `<i class="fas fa-pause"></i> Pauza`; } else { const textContainer = button.closest('[data-text]'); if (textContainer && textContainer.dataset.text) { document.querySelectorAll('[data-action="lector-play-pause"]').forEach(btn => { btn.innerHTML = `<i class="fas fa-play"></i> Odsłuchaj`; }); lektor.enqueue(textContainer.dataset.text); this.state.currentLectorTarget = targetId; button.innerHTML = `<i class="fas fa-pause"></i> Pauza`; } } }
                if (action === 'like') { if(button.disabled) return; const article = button.closest('[data-doc-id]'); const docId = article.dataset.docId; button.disabled = true; await SectionLoader.incrementLikes(docId); const counter = article.querySelector('[data-likes-counter]'); const currentLikes = parseInt(counter.innerText.match(/\d+/)[0] || 0); counter.innerHTML = `<i class="fas fa-heart"></i> Polubienia: ${currentLikes + 1}`; button.innerHTML = `<i class="fas fa-check"></i> Polubiono`; }
                if (action === 'read-more') { const article = button.closest('.story-item'); const content = article.querySelector('.full-content'); if (content) { if (content.style.display === 'none' || !content.style.display) { content.style.display = 'block'; button.textContent = 'Ukryj'; } else { content.style.display = 'none'; button.textContent = 'Czytaj Dalej'; } } }
            });
        },
        
        fetch: {
            async fetchNoOp() { return null; },
            async fetchSingleEntry() { const entriesRef = collection(db, 'sekcje', SectionLoader.state.sectionName, 'entries'); const q = query(entriesRef, limit(1)); const snapshot = await getDocs(q); return snapshot.empty ? null : snapshot.docs[0]; },
            async fetchAllEntries(queryOptions = []) { const collectionPath = `sekcje/${SectionLoader.state.sectionName}/entries`; const entriesRef = collection(db, collectionPath); const q = query(entriesRef, ...queryOptions); const snapshot = await getDocs(q); return snapshot.docs; },
            async fetchAllHelpEntries() { const q = query(collection(db, 'help'), orderBy('name', 'asc')); const snapshot = await getDocs(q); return snapshot.docs; }
        },
        
        async incrementViews(docId) { if (!docId) return; const ref = doc(db, 'sekcje', SectionLoader.state.sectionName, 'entries', docId); await updateDoc(ref, { views: increment(1) }); },
        async incrementLikes(docId) { if (!docId) return; const ref = doc(db, 'sekcje', SectionLoader.state.sectionName, 'entries', docId); await updateDoc(ref, { likes: increment(1) }); },

        render: {
            renderBottleSection() {
                const contentWrapper = SectionLoader.elements.wrapper;
                const iconVolumeMute = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512' fill='%23ffffff'%3E%3Cpath d='M320 64c0-12.6-7.4-24-18.9-29.2s-25-3.1-34.4 5.3L131.8 160H48c-26.5 0-48 21.5-48 48v96c0 26.5 21.5 48 48 48h83.8l134.9 119.9c9.4 8.4 22.9 10.4 34.4 5.3S320 460.6 320 448V64zM592 192a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM524.3 96.2c-9.1-6.4-21.2-4.5-28.3 4.2L435.7 183.3c-7.1 8.7-5.5 20.8 3.5 28.3c8.9 7.4 21.4 5.7 28.6-2.9L528 126.1c7.1-8.7 5.5-20.8-3.5-28.3l-1.2-1.6zM464 352a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM439.5 411.5c8.9-7.4 10.4-20 3.5-28.3c-7.1-8.7-19.6-10.3-28.6-2.9L354.1 463c-8.7 7.1-10.3 19.6-2.9 28.6c7.4 8.9 20 10.4 28.3 3.5l60-43.6z'/%3E%3C/svg%3E";
                const iconVolumeUp = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512' fill='%23ffffff'%3E%3Cpath d='M533.6 32.5C528.3 12.3 508.4 0 486.3 0H214.7C192.6 0 172.7 12.3 167.5 32.5L103.7 234.3H48c-26.5 0-48 21.5-48 48v96c0 26.5 21.5 48 48 48h55.7l63.8 201.5c5.2 20.2 25.1 32.5 47.2 32.5H486.3c22.1 0 42-12.3 47.2-32.5L592.3 426.3H640c26.5 0 48-21.5 48-48v-96c0-26.5-21.5-48-48-48h-48.3L533.6 32.5zM275.9 128h96.2l-32 101.3H307.9l-32-101.3zM214.7 448H425.3l-32-101.3H246.7l-32 101.3z'/%3E%3C/svg%3E";
                let isSoundEnabled = false;
                const oceanSound = new Audio('/audio/morze.mp3');
                oceanSound.loop = true;
                oceanSound.volume = 0.4;
                const backgroundImage = "url('/img/morze.webp')";
                contentWrapper.innerHTML = `
                    <style>
                        .bottle-section { width: 100%; min-height: 100vh; height: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: #fff; position: relative; overflow: hidden; background-image: ${backgroundImage} !important; background-size: cover !important; background-position: center center !important; background-repeat: no-repeat !important; background-attachment: fixed !important; }
                        .bottle-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%); }
                        .bottle-container { position: relative; z-index: 1; padding: 2rem; animation: fadeIn 2s ease-in-out; }
                        .bottle-intro p { font-style: italic; font-size: 1.3rem; max-width: 700px; margin: 0 auto 2.5rem auto; color: #ddd; line-height: 1.9; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
                        .bottle-button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); padding: 1rem 2rem; font-size: 1.2rem; cursor: pointer; border-radius: 50px; backdrop-filter: blur(5px); transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 1.5px; box-shadow: inset 0 -4px 10px rgba(0,0,0,0.4), 0 4px 10px rgba(0,0,0,0.2), 0 0 20px rgba(255,255,255,0.1); }
                        .bottle-button:hover { transform: translateY(-2px); box-shadow: inset 0 -4px 12px rgba(0,0,0,0.3), 0 6px 12px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.15); }
                        .bottle-button:active { transform: translateY(1px); box-shadow: inset 0 -2px 5px rgba(0,0,0,0.5); }
                        #drawLetterBtn, #returnLetterBtn { color: #E0C56E; text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
                        .bottle-letter { display: none; background: rgba(10, 15, 25, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; max-width: 650px; padding: 2.5rem 3.5rem; box-shadow: 0 8px 32px 0 rgba(0, 150, 255, 0.3), 0 0 15px rgba(0, 150, 255, 0.2); }
                        .bottle-letter p { font-family: 'Georgia', 'Times New Roman', serif; font-size: 1.7rem; line-height: 1.9; color: transparent; background: linear-gradient(180deg, #FFDDE1 20%, #FFFFFF 50%, #BDBDBD 85%); -webkit-background-clip: text; background-clip: text; text-shadow: 0 1px 1px rgba(0,0,0,0.5), 0 0 15px rgba(0, 150, 255, 0.4), 0 0 40px rgba(0, 150, 255, 0.2); }
                        .sound-toggle-main { position: fixed; top: 15px; right: 15px; width: 28px; height: 28px; cursor: pointer; z-index: 1002; transition: transform 0.2s ease; background-repeat: no-repeat; background-position: center; background-size: contain; }
                        .sound-toggle-main:hover { transform: scale(1.15); }
                        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
                    </style>
                    <div class="bottle-section">
                        <div id="mainSoundToggle" class="sound-toggle-main" title="Włącz/Wyłącz dźwięk otoczenia"></div>
                        <div class="bottle-container">
                            <div id="bottleIntro" class="bottle-intro">
                                <p>Morze, które widzisz przed sobą, jest starsze niż jakikolwiek ból... Czasem, bardzo rzadko, wyrzuca na brzeg butelkę. A w niej list. Sprawdź, co morze ma dziś do powiedzenia Tobie.</p>
                                <button id="drawLetterBtn" class="bottle-button">Wyłów list z morza</button>
                            </div>
                            <div id="bottleLetter" class="bottle-letter">
                                <p id="letterText"></p>
                                <button id="returnLetterBtn" class="bottle-button" style="margin-top: 2rem;">Wrzuć list z powrotem</button>
                            </div>
                        </div>
                    </div>
                `;
                let lettersCache = [];
                const mainSoundToggle = contentWrapper.querySelector('#mainSoundToggle');
                mainSoundToggle.style.backgroundImage = `url("${iconVolumeMute}")`;
                const toggleMainSound = () => { isSoundEnabled = !isSoundEnabled; if (isSoundEnabled) { mainSoundToggle.style.backgroundImage = `url("${iconVolumeUp}")`; oceanSound.play().catch(e => {}); } else { mainSoundToggle.style.backgroundImage = `url("${iconVolumeMute}")`; oceanSound.pause(); } };
                mainSoundToggle.addEventListener('click', toggleMainSound);
                const bottleIntro = contentWrapper.querySelector('#bottleIntro'), bottleLetter = contentWrapper.querySelector('#bottleLetter'), drawLetterBtn = contentWrapper.querySelector('#drawLetterBtn'), returnLetterBtn = contentWrapper.querySelector('#returnLetterBtn'), letterText = contentWrapper.querySelector('#letterText');
                const fetchLetters = async () => { if (lettersCache.length > 0) return; try { const q = query(collection(db, 'letters')); const snapshot = await getDocs(q); snapshot.forEach(doc => lettersCache.push(doc.data().text || 'Pusta butelka.')); if (lettersCache.length === 0) lettersCache.push("Morze jest dziś spokojne i nie wyrzuciło żadnych listów."); } catch (e) { console.error("Błąd podczas pobierania listów:", e); lettersCache.push("Fale były zbyt silne, by wyłowić list."); } };
                const drawLetter = () => { if (lettersCache.length === 0) return; letterText.textContent = lettersCache[Math.floor(Math.random() * lettersCache.length)]; bottleIntro.style.display = 'none'; bottleLetter.style.display = 'block'; };
                const returnLetter = () => { bottleLetter.style.display = 'none'; bottleIntro.style.display = 'block'; };
                drawLetterBtn.addEventListener('click', drawLetter);
                returnLetterBtn.addEventListener('click', returnLetter);
                const observer = new MutationObserver(() => { if (!document.body.contains(contentWrapper)) { oceanSound.pause(); oceanSound.currentTime = 0; observer.disconnect(); } });
                observer.observe(document.body, { childList: true, subtree: true });
                fetchLetters();
            },
            
            renderPiciorys(doc) {
              if (!doc || !doc.exists()) return SectionLoader.render.renderEmpty("Brak danych dla Piciorysu.");
              const entry = doc.data(); const { escapeHtml } = SectionLoader.utils; const introText = (entry.text || '').split('---PODZIAL---')[0] || "Brak tekstu wstępu."; const mainText = (entry.text || '').split('---PODZIAL---')[1] || "Brak tekstu głównego.";
              const html = `<div class="log-container" data-doc-id="${doc.id}"><div id="piciorys-intro" data-text="${escapeHtml(introText)}"><h2 class="log-title">${escapeHtml(entry.introTitle || "Nazywam się Alkohol")}</h2><div class="log-content" id="intro-content-target"></div><div class="log-actions"><button class="action-button" data-action="lector-play-pause" data-target="piciorys-intro"><i class="fas fa-play"></i> Odsłuchaj</button><button id="continue-btn" class="action-button"><i class="fas fa-book-open"></i> Czytaj dalej</button></div></div><div id="piciorys-main" style="display: none;" data-text="${escapeHtml(mainText)}"><hr class="piciorys-separator"><h2 class="log-title">${escapeHtml(entry.mainTitle || "Piciorys Chudego")}</h2><div class="log-meta"><span><i class="fas fa-eye"></i> ${entry.views || 0}</span><span data-likes-counter><i class="fas fa-heart"></i> Polubienia: ${entry.likes || 0}</span></div><div class="log-content" id="main-content-target"></div><div class="log-actions"><button class="action-button" data-action="lector-play-pause" data-target="piciorys-main"><i class="fas fa-play"></i> Odsłuchaj</button><button class="action-button" data-action="like"><i class="fas fa-heart"></i> Lubię to</button></div></div></div>`;
              SectionLoader.elements.wrapper.innerHTML = html;
              SectionLoader.modules.typewriter.start(document.getElementById('intro-content-target'), introText);
              document.getElementById('continue-btn').addEventListener('click', () => { lektor.stop(); document.querySelector('[data-action="lector-play-pause"][data-target="piciorys-intro"]').innerHTML = `<i class="fas fa-play"></i> Odsłuchaj`; SectionLoader.state.currentLectorTarget = null; document.getElementById('piciorys-intro').style.display = 'none'; document.getElementById('piciorys-main').style.display = 'block'; SectionLoader.modules.typewriter.start(document.getElementById('main-content-target'), mainText); SectionLoader.incrementViews(doc.id); }, { once: true });
            },

            renderKsiezniczka(doc) {
                if (!doc || !doc.exists()) return SectionLoader.render.renderEmpty();
                const entry = doc.data(); const fullText = escapeHtml(`${entry.title || ''}. ${entry.text || ''}`);
                const html = `<main class="content-container story-container" data-doc-id="${doc.id}" data-text="${fullText}"><h2 class="fancy-title">Z punktu widzenia księżniczki</h2><article class="story-item"><h3>${SectionLoader.utils.escapeHtml(entry.title || '')}</h3><div>${entry.text || ''}</div><button class="action-button" data-action="lector-play-pause" data-target="${doc.id}"><i class="fas fa-volume-up"></i> Odsłuchaj</button></article></main>`;
                SectionLoader.elements.wrapper.innerHTML = html;
            },

            renderPomoc(docs) { SectionLoader.elements.wrapper.innerHTML = "<h2>Pomoc - w budowie</h2>"; },

            renderStandard(docs) {
              if (!docs || docs.length === 0) return SectionLoader.render.renderEmpty();
              const { escapeHtml, stripHtml } = SectionLoader.utils;
              const items = docs.map(doc => {
                const e = doc.data();
                const fullContentForLector = escapeHtml(`${e.title || ''}. ${stripHtml(e.text || '')}`);
                const fullContentForDisplay = e.text || '';
                const excerpt = stripHtml(fullContentForDisplay).substring(0, 300) + (fullContentForDisplay.length > 300 ? '...' : '');

                return `
                  <article class="story-item" data-doc-id="${doc.id}" data-text="${fullContentForLector}">
                    <h3 class="entry-title">${escapeHtml(e.title || 'Bez tytułu')}</h3>
                    <div class="entry-meta">
                      <span><i class="fas fa-user-edit"></i> Autor: ${escapeHtml(e.author || 'Chudy')}</span>
                      <span><i class="fas fa-calendar-alt"></i> ${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : 'Brak daty'}</span>
                      <span data-likes-counter><i class="fas fa-heart"></i> Polubienia: ${e.likes || 0}</span>
                      <span><i class="fas fa-eye"></i> Wyświetlenia: ${e.views || 0}</span>
                    </div>
                    <div class="entry-content">
                        <p>${excerpt}</p>
                        <div class="full-content" style="display: none;">${fullContentForDisplay}</div>
                    </div>
                    <div class="log-actions">
                        <button class="action-button" data-action="read-more">Czytaj Dalej</button>
                        <button class="action-button" data-action="lector-play-pause" data-target="${doc.id}"><i class="fas fa-play"></i> Odsłuchaj</button>
                        <button class="action-button" data-action="like"><i class="fas fa-heart"></i> Lubię to</button>
                    </div>
                  </article>`;
              }).join('');
              const html = `<div class="content-container"><h2 class="fancy-title">${escapeHtml(SectionLoader.state.sectionName)}</h2><div class="story-list">${items}</div></div>`;
              SectionLoader.elements.wrapper.innerHTML = html;
              docs.forEach(doc => SectionLoader.incrementViews(doc.id));
            },

            renderError(title, message) { SectionLoader.elements.wrapper.innerHTML = `<div class="content-container"><h2 class="fancy-title">${title}</h2><p>${message}</p></div>`; },
            renderEmpty(message = "Brak wpisów w tej sekcji.") { SectionLoader.render.renderError(SectionLoader.state.sectionName, message); }
        },

        modules: {
            typewriter: {
                start(element, text, speed = 30) {
                    if (!element || !text) { if (element) element.innerHTML = "(Brak tekstu)"; return; }
                    let i = 0; element.innerHTML = '<span class="typing-cursor"></span>';
                    function type() { if (i < text.length) { element.innerHTML = text.substring(0, i + 1).replace(/\n/g, '<br>') + '<span class="typing-cursor"></span>'; i++; setTimeout(type, speed); } else { element.innerHTML = text.replace(/\n/g, '<br>'); } }
                    type();
                }
            }
        }
    };

    document.addEventListener("DOMContentLoaded", () => SectionLoader.init());
  </script>
</body>
</html>

