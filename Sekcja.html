<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Od Dna do ≈öwiat≈Ça ‚Äì Sekcja</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .back-to-home-button { position: fixed; top: 15px; right: 15px; z-index: 1001; font-size: 1em; padding: 12px 25px; }
    .story-container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .story-item { background-color: rgba(10,10,10,0.85); margin-bottom: 20px; padding: 20px; border-radius: 8px; color: #f0f0f0; }
    .wpis-calosc { margin-top: 15px; }
    .speak-button { margin-top: 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .czytaj-dalej-btn { margin-top: 10px; background: #444; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
    .accordion { background-color: #222; color: #fff; cursor: pointer; padding: 10px 15px; width: 100%; text-align: left; border: none; outline: none; transition: 0.4s; border-radius: 5px; margin-top: 10px; }
    .accordion.active { background-color: #444; }
    .panel { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding: 0 10px; background: rgba(0,0,0,0.6); border-radius: 5px; margin-bottom: 10px; }
    .filter-bar { margin-bottom: 15px; text-align: center; }
  </style>
</head>
<body>
  <a href="index.html" class="back-to-home-button"><i class="fas fa-arrow-left"></i> Powr√≥t</a>
  <div id="dynamic-content-wrapper">
    <p style="text-align:center; padding-top: 50px;">≈Åadowanie...</p>
  </div>

<script type="module">
import { db } from './js/firebase-config.js';
import { collection, query, orderBy, getDocs, collectionGroup, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const sectionName = (params.get('section') || '').trim();
const wrapper = document.getElementById('dynamic-content-wrapper');

function createLector(buttonId, textElementId, buttonText="Ods≈Çuchaj") {
    const btn = document.getElementById(buttonId);
    if (!btn) return;
    const textElement = document.getElementById(textElementId);
    if (!textElement) return;

    const fullText = (textElement.textContent || textElement.innerText || "").trim();
    if (!fullText) { btn.disabled=true; btn.style.opacity=0.5; return; }

    const sentences = fullText.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [fullText];
    let currentIndex=0, isReading=false;

    function readSentence(i){
        if(!isReading || i>=sentences.length){
            window.speechSynthesis.cancel(); isReading=false; btn.textContent=`‚ñ∂Ô∏è ${buttonText}`; currentIndex=0; return;
        }
        const utterance = new SpeechSynthesisUtterance(sentences[i].trim());
        utterance.lang = "pl-PL";
        utterance.onend = ()=>{ if(isReading){ currentIndex++; readSentence(currentIndex); } };
        window.speechSynthesis.speak(utterance);
    }

    btn.addEventListener("click", ()=>{
        const synth = window.speechSynthesis;
        if(isReading){ isReading=false; synth.cancel(); btn.textContent=`üîÑ Wzn√≥w`; }
        else { isReading=true; btn.textContent=`‚è∏Ô∏è Pauza`; readSentence(currentIndex); }
    });

    window.addEventListener("beforeunload",()=>window.speechSynthesis.cancel());
}

(async()=>{
    try{
        if(!sectionName){ wrapper.innerHTML="<p>B≈ÇƒÖd: brak nazwy sekcji.</p>"; return; }

        document.title=`${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;
        const entriesRef = collection(db,'sekcje',sectionName,'entries');
        let snap = await getDocs(query(entriesRef, orderBy("createdAt","desc")));

        if(snap.empty){ wrapper.innerHTML=`<h1>${sectionName}</h1><p>Brak wpis√≥w w tej sekcji.</p>`; return; }

        let entriesHTML = snap.docs.map(doc=>{
            const e=doc.data();
            const contentId=`content-full-${doc.id}`;
            const buttonId=`button-speak-${doc.id}`;
            const skrot=e.text.replace(/<[^>]*>?/gm,'').substring(0,300);

            return `
            <div class="story-item">
                <h2 class="fancy-title">${e.title || 'Bez tytu≈Çu'}</h2>
                <div class="entry-item-meta">${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : ''}</div>
                <div class="wpis-skrot"><p>${skrot}...</p></div>
                <div id="${contentId}" class="wpis-calosc" style="display:none;">${e.text}</div>
                <div class="speak-button-container">
                    <button class="czytaj-dalej-btn">...czytaj dalej</button>
                    <button id="${buttonId}" class="speak-button" style="display:none;">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                </div>
            </div>`;
        }).join('');

        wrapper.innerHTML=`<header><h1>${sectionName}</h1></header><main><div class="story-container">${entriesHTML}</div></main>`;

        document.querySelectorAll('.czytaj-dalej-btn').forEach(button=>{
            button.addEventListener('click',function(){
                const storyItem=this.closest('.story-item');
                const skrot=storyItem.querySelector('.wpis-skrot');
                const calosc=storyItem.querySelector('.wpis-calosc');
                const lektorBtn=storyItem.querySelector('.speak-button');
                const isVisible = calosc.style.display==='block';
                if(isVisible){
                    calosc.style.display='none';
                    lektorBtn.style.display='none';
                    skrot.style.display='block';
                    this.textContent='...czytaj dalej';
                } else {
                    calosc.style.display='block';
                    lektorBtn.style.display='inline-flex';
                    skrot.style.display='none';
                    this.textContent='Zwi≈Ñ';
                }
            });
        });

        snap.docs.forEach(doc=>{
            const contentId=`content-full-${doc.id}`;
            const buttonId=`button-speak-${doc.id}`;
            createLector(buttonId,contentId);
        });

    } catch(err){ console.error("B≈ÇƒÖd krytyczny:",err); wrapper.innerHTML=`<p>B≈ÇƒÖd ≈Çadowania sekcji. Sprawd≈∫ konsolƒô.</p>`; }
})();
</script>
</body>
</html>
