<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie...</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="dynamic-content-wrapper">
    <p style="text-align:center; padding-top:50px;">≈Åadowanie...</p>
  </div>

  <!-- Rozdzielone kontenery -->
  <div id="kronika-wrapper" style="display:none;"></div>
  <div id="piciorys-wrapper" style="display:none;"></div>
  <div id="ksiezniczka-wrapper" style="display:none;"></div>
  <div id="pomoc-wrapper" style="display:none;"></div>
  <div id="galeria-wrapper" style="display:none;"></div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const sectionName = (params.get('nazwa') || '').trim();

    // --- WYB√ìR W≈ÅA≈öCIWEGO WRAPPERA ---
    let wrapper;
    switch(sectionName) {
      case 'Kronika': wrapper = document.getElementById('kronika-wrapper'); break;
      case 'Piciorys Chudego': wrapper = document.getElementById('piciorys-wrapper'); break;
      case 'Z punktu widzenia ksiƒô≈ºniczki': wrapper = document.getElementById('ksiezniczka-wrapper'); break;
      case 'Pomoc': wrapper = document.getElementById('pomoc-wrapper'); break;
      case 'Galeria': wrapper = document.getElementById('galeria-wrapper'); break;
      default: wrapper = document.getElementById('dynamic-content-wrapper');
    }
    wrapper.style.display = 'block';
    document.documentElement.className = '';

    function createLector(buttonId, textElementId, buttonText="Ods≈Çuchaj") {
      const btn = document.getElementById(buttonId);
      if (!btn) return;
      const textEl = document.getElementById(textElementId);
      if (!textEl) return;

      const fullText = (textEl.textContent || textEl.innerText || "").trim();
      if (!fullText) { btn.disabled=true; btn.style.opacity=0.5; return; }

      const sentences = fullText.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [fullText];
      let currentIndex=0, isReading=false;

      function readSentence(i) {
        if (!isReading || i>=sentences.length) {
          window.speechSynthesis.cancel();
          isReading=false; btn.textContent=`‚ñ∂Ô∏è ${buttonText}`; currentIndex=0;
          return;
        }
        const utterance = new SpeechSynthesisUtterance(sentences[i].trim());
        utterance.lang="pl-PL";
        utterance.onend=()=>{ if(isReading){currentIndex++; readSentence(currentIndex);} };
        window.speechSynthesis.speak(utterance);
      }

      btn.addEventListener("click", ()=>{
        const synth=window.speechSynthesis;
        if(isReading){isReading=false; synth.cancel(); btn.textContent=`üîÑ Wzn√≥w`;}
        else{isReading=true; btn.textContent=`‚è∏Ô∏è Pauza`; readSentence(currentIndex);}
      });
      window.addEventListener("beforeunload",()=>window.speechSynthesis.cancel());
    }

    (async ()=>{
      try {
        if(!sectionName){
          wrapper.innerHTML=`<header class="page-header"><h1>B≈ÇƒÖd</h1></header>
          <main><div class="story-container">Brak nazwy sekcji w adresie URL.</div></main>`;
          return;
        }

        // --- KLASY TEMATYCZNE ---
        let themeClass='theme-kronika';
        if(sectionName==='Piciorys Chudego'){themeClass='theme-piciorys';}
        else if(sectionName.toLowerCase().includes('ksiƒô≈ºniczki')){themeClass='theme-ksiezniczka';}
        else if(sectionName==='Pomoc'){themeClass='theme-pomoc';}
        else if(sectionName==='Galeria'){themeClass='theme-galeria';}
        document.documentElement.className=themeClass;
        document.title=`${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;

        const entriesRef = collection(db,'sekcje',sectionName,'entries');

        // --- Piciorys i Ksiƒô≈ºniczka ---
        if(sectionName==='Piciorys Chudego' || sectionName.toLowerCase().includes('ksiƒô≈ºniczki')){
          const snap = await getDocs(query(entriesRef, limit(1)));
          if(snap.empty){
            wrapper.innerHTML=`<header class="page-header"><h1>${sectionName}</h1>
            <a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
            <main><div class="story-container"><div class="story-item"><p>Brak wpisu w tej sekcji.</p></div></div></main>`;
            return;
          }
          const entry=snap.docs[0].data();

          if(sectionName==='Piciorys Chudego'){
            const [quote,historia]=(entry.text||'').split('---PODZIAL---');
            wrapper.innerHTML=`<header class="page-header"><h1>${sectionName}</h1>
            <a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
            <main><article class="newspaper-article">
              <div id="piciorys-wstep">
                <div class="newspaper-headline-wrapper">
                  <h2 class="newspaper-headline">${entry.title||''}</h2>
                  <div class="newspaper-headline-quote">${quote||''}</div>
                </div>
              </div>
              <div class="speak-button-container"><button id="speakBtn1" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Wstƒôp</button></div>
              <div id="piciorys-historia" class="newspaper-text-content">${historia||''}</div>
              <div class="speak-button-container"><button id="speakBtn2" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Historiƒô</button></div>
            </article></main>`;
            createLector("speakBtn1","piciorys-wstep","Ods≈Çuchaj Wstƒôp");
            createLector("speakBtn2","piciorys-historia","Ods≈Çuchaj Historiƒô");
          } else {
            wrapper.innerHTML=`<div class="magic-background"><div id="stars1"></div><div id="stars2"></div><div id="stars3"></div></div>
            <header class="page-header"><h1>${sectionName}</h1>
            <a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
            <main><div class="content-wrapper"><div class="story-box">
              <div id="ksiezniczka-text"><h2>${entry.title||''}</h2>${entry.text||''}</div>
              <div class="speak-button-container"><button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button></div>
            </div></div></main>`;
            createLector("speakBtn","ksiezniczka-text");
          }
        }

        // --- Pomoc ---
        else if(sectionName==='Pomoc'){
          const snap = await getDocs(query(entriesRef, orderBy("woj")));
          const groupedByWoj = snap.docs.reduce((acc, doc)=>{const entry=doc.data(); const woj=entry.woj||'Inne'; if(!acc[woj]) acc[woj]=[]; acc[woj].push(entry); return acc;}, {});
          const wojOrder=['Og√≥lnopolskie', ...Object.keys(groupedByWoj).filter(w=>w!=='Og√≥lnopolskie').sort()];
          let accordionsHTML='';
          for(const woj of wojOrder){
            if(groupedByWoj[woj]){
              const entriesHTML=groupedByWoj[woj].map(e=>`<div class="place-entry">
                <h3>${e.name||'Brak nazwy'}</h3>
                <p>${e.address?'Adres: '+e.address:''}</p>
                <p>${e.phone?'Telefon: '+e.phone:''}</p>
                <p>${e.desc||'Brak opisu.'}</p>
                ${e.link?`<p><a href="${e.link}" target="_blank" rel="noopener">Przejd≈∫ do strony</a></p>`:''}
              </div>`).join('');
              const icon=wo==='Og√≥lnopolskie'?'üìû':'üè•';
              accordionsHTML+=`<div class="woj-group" data-woj="${woj}">
                <button class="accordion">${icon} ${woj}</button>
                <div class="panel">${entriesHTML}</div>
              </div>`;
            }
          }
          wrapper.innerHTML=`<header class="page-header"><h1>Gdzie szukaƒá pomocy ‚Äì Uzale≈ºnienia</h1>
          <a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
          <main><div class="container">
          <div class="filter-bar">
            <label for="wojewodztwoSelect"><strong>Filtruj wg wojew√≥dztwa:</strong></label>
            <select id="wojewodztwoSelect">
              <option value="all">Wszystkie</option>
              ${wojOrder.map(w=>`<option value="${w}">${w}</option>`).join('')}
            </select>
          </div>${accordionsHTML||'<p>Brak o≈õrodk√≥w w bazie danych.</p>'}</div></main>`;

          document.querySelectorAll('.accordion').forEach(acc=>{
            acc.addEventListener('click',function(){
              this.classList.toggle('active');
              const panel=this.nextElementSibling;
              panel.style.maxHeight=panel.style.maxHeight?null:panel.scrollHeight+"px";
            });
          });
          const select=document.getElementById('wojewodztwoSelect');
          const wojGroups=document.querySelectorAll('.woj-group');
          select.addEventListener('change',function(){
            wojGroups.forEach(group=>{group.style.display=(this.value==='all'||group.dataset.woj===this.value)?'block':'none';});
          });
        }

        // --- Kronika i inne ---
        else{
          const snap = await getDocs(query(entriesRef, orderBy("createdAt","desc")));
          let entriesHTML='';
          if(snap.empty){entriesHTML=`<div class="story-item"><p>Brak wpis√≥w w tej sekcji.</p></div>`;}
          else{
            entriesHTML = snap.docs.map(doc=>{
              const e=doc.data();
              const skrot=e.text.replace(/<[^>]*>?/gm,'').substring(0,300);
              const contentId=`content-full-${doc.id}`;
              const buttonId=`button-speak-${doc.id}`;
              return `<div class="story-item">
                <h2 class="fancy-title">${e.title||'Bez tytu≈Çu'}</h2>
                <div class="entry-item-meta">${e.createdAt?e.createdAt.toDate().toLocaleDateString('pl-PL'):''}</div>
                <div class="wpis-skrot"><p>${skrot}...</p></div>
                <div id="${contentId}" class="wpis-calosc" style="display:none;">${e.text}</div>
                <div class="speak-button-container">
                  <button class="czytaj-dalej-btn">...czytaj dalej</button>
                  <button id="${buttonId}" class="speak-button" style="display:none;">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                </div>
              </div>`;
            }).join('');
          }
          wrapper.innerHTML=`<header class="page-header"><h1>${sectionName}</h1>
          <a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
          <main><div class="story-container">${entriesHTML}</div></main>`;

          document.querySelectorAll('.czytaj-dalej-btn').forEach(button=>{
            button.addEventListener('click',function(){
              const storyItem=this.closest('.story-item');
              const skrot=storyItem.querySelector('.wpis-skrot');
              const calosc=storyItem.querySelector('.wpis-calosc');
              const lektorBtn=storyItem.querySelector('.speak-button');
              const isVisible=calosc.style.display==='block';
              if(isVisible){calosc.style.display='none'; lektorBtn.style.display='none'; skrot.style.display='block'; this.textContent='...czytaj dalej';}
              else{calosc.style.display='block'; lektorBtn.style.display='inline-flex'; skrot.style.display='none'; this.textContent='Zwi≈Ñ';}
            });
          });
          if(!snap.empty) snap.docs.forEach(doc=>{
            const contentId=`content-full-${doc.id}`;
            const buttonId=`button-speak-${doc.id}`;
            createLector(buttonId,contentId);
          });
        }

      }catch(err){
        console.error("B≈ÇƒÖd krytyczny w Sekcja.html:",err);
        wrapper.innerHTML=`<header class="page-header"><h1>B≈ÇƒÖd krytyczny</h1></header>
        <main><div class="story-container"><p>WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania strony. Sprawd≈∫ konsolƒô (F12), aby zobaczyƒá szczeg√≥≈Çy.</p></div></main>`;
      }
    })();
  </script>
</body>
</html>
