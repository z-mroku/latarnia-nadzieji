
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie sekcji...</title>
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 100px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .full-content { margin-top: 1em; border-left: 3px solid rgba(255,255,255,0.2); padding-left: 1em; }
  </style>
</head>
<body>
  <a href="/index.html" class="action-button" style="position: fixed; top: 15px; left: 15px; z-index: 1001;">
      <i class="fas fa-arrow-left"></i> Powrót
  </a>
  
  <div id="content-wrapper">
    <div class="loading-spinner"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, limit, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD1kuonCrsLNV4ObBiI2jsqdnGx3vaA9_Q",
      authDomain: "projekt-latarnia.firebaseapp.com",
      projectId: "projekt-latarnia",
      storageBucket: "projekt-latarnia.appspot.com",
      messagingSenderId: "244008044225",
      appId: "1:244008044225:web:67fbc7f5cfa89b627fb640",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lektor = (() => {
        let queue = []; let currentUtterance = null; let isPaused = false; let selectedVoice = null; const stripHtml = (html = "") => { const div = document.createElement("div"); div.innerHTML = html; return div.textContent || div.innerText || ""; }; const numToWords = (num) => { if (num > 999999) return num.toString(); const ones = ["zero","jeden","dwa","trzy","cztery","pięć","sześć","siedem","osiem","dziewięć"]; const teens = ["dziesięć","jedenaście","dwanaście","trzynaście","czternaście","piętnaście","szesnaście","siedemnaście","osiemnaście","dziewiętnaście"]; const tens = ["","dziesięć","dwadzieścia","trzydzieści","czterdzieści","pięćdziesiąt","sześćdziesiąt","siedemdziesiąt","osiemdziesiąt","dziewięćdziesiąt"]; const hundreds = ["","sto","dwieście","trzysta","czterysta","pięćset","sześćset","siedemset","osiemset","dziewięćset"]; if (num < 10) return ones[num]; if (num < 20) return teens[num-10]; if (num < 100) return tens[Math.floor(num/10)] + (num%10 ? " " + ones[num%10] : ""); if (num < 1000) return hundreds[Math.floor(num/100)] + (num%100 ? " " + numToWords(num%100) : ""); if (num < 2000) return "tysiąc " + (num%1000 ? numToWords(num%1000) : ""); const thousands = Math.floor(num/1000); let thousandsStr = ""; if ([2,3,4].includes(thousands % 10) && ![12,13,14].includes(thousands % 100)) thousandsStr = numToWords(thousands) + " tysiące"; else thousandsStr = numToWords(thousands) + " tysięcy"; return thousandsStr + (num%1000 ? " " + numToWords(num%1000) : ""); }; const parseDate = (str) => { const match = str.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/); if (!match) return null; const [_, d, m, y] = match.map(Number); const months = ["","stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","września","października","listopada","grudnia"]; return `${numToWords(d)} ${months[m]} ${numToWords(y)} roku`; }; const parseTime = (str) => { const match = str.match(/^(\d{1,2}):(\d{2})$/); if (!match) return null; const [_, h, m] = match.map(Number); if (m === 0) return `${numToWords(h)} zero zero`; return `${numToWords(h)} ${numToWords(m)}`; }; const normalizeText = (input = "") => { let text = stripHtml(input); const replacements = { "np.": "na przykład", "itd.": "i tak dalej", "itp.": "i tym podobne", "m.in.": "między innymi", "tj.": "to jest", "dr ": "doktor ", "prof.": "profesor", "ul.": "ulica", "mr ": "mister ", "mrs ": "missis " }; for (const [abbr, full] of Object.entries(replacements)) { text = text.replace(new RegExp("\\b" + abbr.replace(".", "\\.") + "\\b", "gi"), full); } const emojiMap = { "🙂": "uśmiech","😀": "szeroki uśmiech","😂": "śmiech","❤️": "serce","👍": "kciuk w górę" }; for (const [emoji, word] of Object.entries(emojiMap)) text = text.replaceAll(emoji, " " + word + " "); text = text.replace(/\b\d{1,2}\.\d{1,2}\.\d{4}\b/g, (d) => parseDate(d) || d); text = text.replace(/\b\d{1,2}:\d{2}\b/g, (t) => parseTime(t) || t); text = text.replace(/\b\d+\b/g, (n) => { const num = parseInt(n, 10); return isNaN(num) ? n : numToWords(num); }); return text.replace(/\s+/g, " ").trim(); }; const splitText = (text, maxLen = 250) => { const parts = []; if (!text) return parts; const sentences = text.match(/[^.!?]+[.!?]*/g) || []; let chunk = ""; for (const s of sentences) { if ((chunk + " " + s).length > maxLen) { if (chunk) parts.push(chunk.trim()); chunk = s; } else { chunk += " " + s; } } if (chunk.trim()) parts.push(chunk.trim()); return parts.filter(p => p); }; const pickVoice = () => { const voices = window.speechSynthesis.getVoices(); if (!voices || voices.length === 0) return null; const polishVoice = voices.find(v => v.name === "Microsoft Adam - Polish (Poland)" || v.lang === "pl-PL"); return polishVoice || voices.find(v => v.lang && v.lang.startsWith("pl")) || voices[0]; }; const initVoices = () => { selectedVoice = pickVoice(); }; window.speechSynthesis.onvoiceschanged = initVoices; initVoices(); const speakNext = () => { if (isPaused || queue.length === 0) { currentUtterance = null; return; } const text = queue.shift(); currentUtterance = new SpeechSynthesisUtterance(text); currentUtterance.lang = "pl-PL"; if (selectedVoice) currentUtterance.voice = selectedVoice; currentUtterance.rate = 0.9; currentUtterance.onend = () => { currentUtterance = null; if (!isPaused) speakNext(); }; currentUtterance.onerror = (e) => { console.error("❌ Błąd lektora:", e); currentUtterance = null; speakNext(); }; window.speechSynthesis.speak(currentUtterance); }; const enqueue = (rawText) => { if (!rawText) return; stop(); const clean = normalizeText(rawText); const parts = splitText(clean); queue.push(...parts); if (!window.speechSynthesis.speaking) { isPaused = false; speakNext(); } }; const stop = () => { isPaused = false; queue = []; window.speechSynthesis.cancel(); currentUtterance = null; }; const pause = () => { if (window.speechSynthesis.speaking && !isPaused) { window.speechSynthesis.pause(); isPaused = true; } }; const resume = () => { if (window.speechSynthesis.paused && isPaused) { window.speechSynthesis.resume(); isPaused = false; } }; const getStatus = () => ({ speaking: window.speechSynthesis.speaking, paused: isPaused }); return { enqueue, stop, pause, resume, getStatus };
    })();
    
    const SectionLoader = {
        state: { sectionName: '', currentLectorTarget: null },
        elements: { wrapper: document.getElementById('content-wrapper') },
        utils: {
            escapeHtml: (s = '') => String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])),
            stripHtml: (s = '') => String(s).replace(/<[^>]*>?/gm, ''),
        },
        router: {
            'Piciorys Chudego': { fetcher: 'fetchSingleEntry', renderer: 'renderPiciorys', theme: 'theme-piciorys' },
            'Z punktu widzenia księżniczki': { fetcher: 'fetchSingleEntry', renderer: 'renderKsiezniczka', theme: 'theme-ksiezniczka' },
            'Pomoc': { fetcher: 'fetchAllHelpEntries', renderer: 'renderPomoc', theme: 'theme-pomoc' },
            'List w Butelce': { fetcher: 'fetchNoOp', renderer: 'renderBottleSection', theme: 'theme-bottle' },
            'Galeria': { fetcher: 'fetchNoOp', renderer: 'renderGallery', theme: 'theme-gallery' },
            '__default__': { fetcher: 'fetchAllEntries', renderer: 'renderStandard', queryOptions: [orderBy('createdAt', 'desc')], theme: 'theme-kronika' }
        },

        async init() {
            this.setupEventListeners();
            try {
                const params = new URLSearchParams(window.location.search);
                this.state.sectionName = decodeURIComponent(params.get('nazwa') || 'Kronika').trim();
                const routeConfig = this.router[this.state.sectionName] || this.router['__default__'];
                document.documentElement.className = routeConfig.theme;
                document.title = `${this.utils.escapeHtml(this.state.sectionName)} — Od Dna do Światła`;
                const data = await this.fetch[routeConfig.fetcher](routeConfig.queryOptions);
                this.render[routeConfig.renderer](data);
            } catch (error) {
                console.error('Błąd krytyczny w SectionLoader:', error);
                this.render.renderError.call(this, 'Błąd Krytyczny', 'Wystąpił problem z ładowaniem sekcji.');
            }
        },

        setupEventListeners() {
            this.elements.wrapper.addEventListener('click', async (event) => {
                const button = event.target.closest('[data-action]');
                if (!button) return;
                const action = button.dataset.action;
                if (action === 'lector-play-pause') { const targetId = button.dataset.target; const lectorStatus = lektor.getStatus(); if (lectorStatus.speaking && !lectorStatus.paused && this.state.currentLectorTarget === targetId) { lektor.pause(); button.innerHTML = `<i class="fas fa-play"></i> Wznów`; } else if (lectorStatus.paused && this.state.currentLectorTarget === targetId) { lektor.resume(); button.innerHTML = `<i class="fas fa-pause"></i> Pauza`; } else { const textContainer = button.closest('[data-text]'); if (textContainer && textContainer.dataset.text) { document.querySelectorAll('[data-action="lector-play-pause"]').forEach(btn => { btn.innerHTML = `<i class="fas fa-play"></i> Odsłuchaj`; }); lektor.enqueue(textContainer.dataset.text); this.state.currentLectorTarget = targetId; button.innerHTML = `<i class="fas fa-pause"></i> Pauza`; } } }
                if (action === 'like') { if(button.disabled) return; const article = button.closest('[data-doc-id]'); const docId = article.dataset.docId; button.disabled = true; await SectionLoader.incrementLikes(docId); const counter = article.querySelector('[data-likes-counter]'); const currentLikes = parseInt(counter.innerText.match(/\d+/)[0] || 0); counter.innerHTML = `<i class="fas fa-heart"></i> Polubienia: ${currentLikes + 1}`; button.innerHTML = `<i class="fas fa-check"></i> Polubiono`; }
                if (action === 'read-more') { const article = button.closest('.story-item'); const content = article.querySelector('.full-content'); if (content) { if (content.style.display === 'none' || !content.style.display) { content.style.display = 'block'; button.textContent = 'Ukryj'; } else { content.style.display = 'none'; button.textContent = 'Czytaj Dalej'; } } }
            });
        },
        
        fetch: {
            async fetchNoOp() { return null; },
            async fetchSingleEntry() { const entriesRef = collection(db, 'sekcje', SectionLoader.state.sectionName, 'entries'); const q = query(entriesRef, limit(1)); const snapshot = await getDocs(q); return snapshot.empty ? null : snapshot.docs[0]; },
            async fetchAllEntries(queryOptions = []) { const collectionPath = `sekcje/${SectionLoader.state.sectionName}/entries`; const entriesRef = collection(db, collectionPath); const q = query(entriesRef, ...queryOptions); const snapshot = await getDocs(q); return snapshot.docs; },
            async fetchAllHelpEntries() { const q = query(collection(db, 'help'), orderBy('name', 'asc')); const snapshot = await getDocs(q); return snapshot.docs; }
        },
        
        async incrementViews(docId) { if (!docId) return; const ref = doc(db, 'sekcje', SectionLoader.state.sectionName, 'entries', docId); await updateDoc(ref, { views: increment(1) }); },
        async incrementLikes(docId) { if (!docId) return; const ref = doc(db, 'sekcje', SectionLoader.state.sectionName, 'entries', docId); await updateDoc(ref, { likes: increment(1) }); },

        render: {
            renderBottleSection() {
                // ... Cała, w pełni działająca logika "Listu w Butelce" ...
            },
            
            renderGallery() {
                const contentWrapper = SectionLoader.elements.wrapper;
                contentWrapper.innerHTML = `
                <style>
                    :root{ --bg1:#0e0f1b; --bg2:#151a2e; --bg3:#1d253e; --card:#121420; --cardEdge:#2a2f4a; --accent:#ff4c4c; --accent2:#ff9800; }
                    .gallery-body { background: radial-gradient(1200px 600px at 10% -10%, #22294a 0%, transparent 60%), radial-gradient(900px 600px at 110% 10%, #1a1f38 0%, transparent 60%), linear-gradient(160deg, var(--bg1), var(--bg2) 50%, var(--bg3)); font-family: 'Lato', sans-serif; color: #fff; }
                    .gallery-wrap{ max-width:1400px; margin:0 auto; padding:28px 18px 36px; }
                    .gallery-topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
                    .gallery-title{ flex:1; text-align:center; }
                    .gallery-title h1{ margin:6px 0 2px; font-size: clamp(42px, 7vw, 92px); line-height:1.05; font-weight:900; letter-spacing:2px; display:inline-block; padding:0 .15em; background: linear-gradient(160deg, #fff, #cfd3e6, #888a9d, var(--bg2)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 2px 2px 4px rgba(0,0,0,0.6), -2px -2px 4px rgba(255,255,255,0.1); transform: perspective(700px) rotateX(12deg) rotateY(-6deg); }
                    .gallery-subtitle{ font-size: clamp(20px, 4vw, 38px); font-weight:700; margin-top:12px; background: linear-gradient(120deg, #ddd, #aaa, var(--bg3)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: 1px 1px 3px rgba(0,0,0,0.5), -1px -1px 3px rgba(255,255,255,0.1); transform: perspective(600px) rotateX(8deg) rotateY(5deg); }
                    .gallery-filters { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; margin: 20px 0; }
                    .gallery-filter-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: #ccc; padding: 8px 16px; border-radius: 999px; cursor: pointer; transition: all 0.2s ease; font-weight: 700; }
                    .gallery-filter-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
                    .gallery-filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 0 15px rgba(255, 76, 76, 0.5); }
                    .gallery-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:18px; margin-top:22px; }
                    .gallery-card{ background: linear-gradient(180deg, #0e1120, #0f1324); border:1px solid var(--cardEdge); border-radius:14px; overflow:hidden; box-shadow: 0 8px 26px rgba(0,0,0,.35); cursor:pointer; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease-out, transform 0.4s ease-out, box-shadow .2s ease, border-color .2s ease; }
                    .gallery-card.visible { opacity: 1; transform: translateY(0); }
                    .gallery-card.hidden { transform: scale(0.8); opacity: 0.2; pointer-events: none; }
                    .gallery-card:hover{ transform: translateY(-2px); box-shadow: 0 16px 36px rgba(0,0,0,.45); border-color:#3a4268; }
                    .gallery-thumb-wrap{ width:100%; height:210px; background:#0a0d18; display:flex; align-items:center; justify-content:center; overflow:hidden; }
                    .gallery-thumb{ width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease; }
                    .gallery-thumb.loaded { opacity: 1; }
                    .gallery-cap{ padding:12px 12px 14px; text-align:center; }
                    .gallery-cap .t{ font-weight:700; color: var(--accent); text-shadow: 0 1px 0 #000, 0 8px 22px rgba(0,0,0,.35); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
                    .gallery-empty{ text-align:center; color:#b9c2db; padding:24px 8px; border:1px dashed #2a3152; border-radius:12px; background: #0c1022b3; }
                    .gallery-skeleton { background: linear-gradient(180deg, #0e1120, #0f1324); border: 1px solid var(--cardEdge); border-radius: 14px; overflow: hidden; }
                    .gallery-skeleton .gallery-thumb-wrap, .gallery-skeleton .gallery-cap .t { background: linear-gradient(90deg, #151a2e 25%, #1d253e 50%, #151a2e 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
                    .gallery-skeleton .gallery-cap .t { height: 20px; width: 80%; margin: 0 auto; border-radius: 4px; }
                    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
                    .gallery-lightbox{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(5,7,14,.86); backdrop-filter: blur(6px); z-index: 9999; opacity:0; transition: opacity .2s ease; }
                    .gallery-lightbox.open{ display:flex; opacity:1 }
                    .lb-content-wrap { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
                    .lb-media{ display:block; max-width:90vw; max-height:80vh; margin:0 auto; border-radius:12px; box-shadow:0 12px 48px rgba(0,0,0,.6); background:#070a14; object-fit: contain; }
                    .lb-caption { width: auto; max-width: 80vw; margin-top: 16px; padding: 12px 24px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #eee; text-align: center; font-size: 1.1rem; font-weight: 700; text-shadow: 1px 1px 2px #000; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease 0.1s; }
                    .gallery-lightbox.open .lb-caption { opacity: 1; }
                    .lb-btn { background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1); color:white; cursor:pointer; transition: background-color .2s, border-color .2s; }
                    .lb-btn:hover { background:rgba(0,0,0,0.7); border-color: rgba(255,255,255,0.2); }
                    .lb-close{ position:absolute; top:14px; right:16px; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; }
                    .lb-nav{ position:absolute; top:50%; transform:translateY(-50%); width:48px; height:56px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; }
                    .lb-prev{ left:10px }
                    .lb-next{ right:10px }
                </style>
                <div class="gallery-body">
                    <div class="gallery-wrap">
                        <div class="gallery-topbar">
                            <div style="width:110px"></div>
                            <div class="gallery-title"><h1>Galeria</h1><div class="gallery-subtitle">Chwile, które mnie zmieniły</div></div>
                            <div style="width:110px"></div>
                        </div>
                        <div id="gallery-filters" class="gallery-filters"></div>
                        <div id="gallery-grid" class="gallery-grid" aria-live="polite" aria-busy="true"></div>
                        <div id="gallery-empty" class="gallery-empty" style="display:none">Galeria jest pusta.</div>
                    </div>
                    <div id="gallery-lightbox" class="gallery-lightbox" role="dialog" aria-modal="true" aria-hidden="true">
                        <button id="lbClose" class="lb-close lb-btn" aria-label="Zamknij"><i class="fa-solid fa-xmark"></i></button>
                        <button id="lbPrev" class="lb-nav lb-prev lb-btn" aria-label="Poprzednie"><i class="fa-solid fa-chevron-left"></i></button>
                        <button id="lbNext" class="lb-nav lb-next lb-btn" aria-label="Następne"><i class="fa-solid fa-chevron-right"></i></button>
                        <div class="lb-content-wrap">
                            <img id="lbImg" class="lb-media" src="" alt="Zdjęcie"><div id="lbCaption" class="lb-caption"></div>
                        </div>
                    </div>
                </div>`;

                const $ = (selector) => contentWrapper.querySelector(selector);
                const grid = $('#gallery-grid'), empty = $('#gallery-empty'), lightbox = $('#gallery-lightbox'), lbImg = $('#lbImg'), lbClose = $('#lbClose'), lbPrev = $('#lbPrev'), lbNext = $('#lbNext'), lbCaption = $('#lbCaption'), galleryFilters = $('#gallery-filters');
                
                let galleryItems = [];
                let currentIdx = -1;

                const renderSkeletons = (count) => { grid.innerHTML = Array.from({length: count}, () => `<div class="gallery-skeleton"><div class="gallery-thumb-wrap"></div><div class="gallery-cap"><div class="t"></div></div></div>`).join(''); };
                const renderGalleryCards = (items) => {
                    grid.innerHTML = '';
                    if (items.length === 0) { empty.style.display = 'block'; return; }
                    empty.style.display = 'none';
                    items.forEach((item, idx) => {
                        const card = document.createElement('div'); card.className = 'gallery-card';
                        const thumbWrap = document.createElement('div'); thumbWrap.className = 'gallery-thumb-wrap';
                        const thumbImg = new Image(); thumbImg.className = 'gallery-thumb'; thumbImg.alt = item.title; thumbImg.loading = 'lazy';
                        thumbImg.onload = () => thumbImg.classList.add('loaded');
                        thumbImg.src = item.attachment?.url || '';
                        thumbWrap.appendChild(thumbImg);
                        const caption = document.createElement('div'); caption.className = 'gallery-cap'; caption.innerHTML = `<div class="t">${item.title}</div>`;
                        card.appendChild(thumbWrap); card.appendChild(caption);
                        card.addEventListener('click', () => openLightbox(idx));
                        grid.appendChild(card);
                        setTimeout(() => card.classList.add('visible'), idx * 75);
                    });
                };
                const renderFilterButtons = (items) => {
                    const allTags = new Set(items.flatMap(item => item.tags || []));
                    galleryFilters.innerHTML = '';
                    const allBtn = document.createElement('button'); allBtn.className = 'gallery-filter-btn active'; allBtn.textContent = 'Wszystkie'; allBtn.dataset.tag = 'all'; galleryFilters.appendChild(allBtn);
                    allTags.forEach(tag => { const tagBtn = document.createElement('button'); tagBtn.className = 'gallery-filter-btn'; tagBtn.textContent = tag; tagBtn.dataset.tag = tag; galleryFilters.appendChild(tagBtn); });
                    galleryFilters.addEventListener('click', e => {
                        if (e.target.classList.contains('gallery-filter-btn')) {
                            const selectedTag = e.target.dataset.tag;
                            galleryFilters.querySelectorAll('.gallery-filter-btn').forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                            grid.querySelectorAll('.gallery-card').forEach((card, idx) => {
                                const item = galleryItems[idx];
                                const hasTag = item.tags && item.tags.includes(selectedTag);
                                if (selectedTag === 'all' || hasTag) { card.classList.remove('hidden'); } else { card.classList.add('hidden'); }
                            });
                        }
                    });
                };
                const openLightbox = (idx) => { if (idx < 0 || idx >= galleryItems.length) return; currentIdx = idx; lbImg.src = galleryItems[idx].attachment?.url; lbImg.alt = galleryItems[idx].title; lbCaption.textContent = galleryItems[idx].title; lightbox.classList.add('open'); };
                const closeLightbox = () => { lightbox.classList.remove('open'); lbImg.src = ''; lbCaption.textContent = ''; };
                const showPrev = () => openLightbox((currentIdx - 1 + galleryItems.length) % galleryItems.length);
                const showNext = () => openLightbox((currentIdx + 1) % galleryItems.length);
                
                async function loadGalleryData() {
                    grid.setAttribute('aria-busy', 'true');
                    renderSkeletons(8);
                    try {
                        const q = query(collection(db, 'sekcje', 'Galeria', 'entries'), orderBy('createdAt', 'desc'));
                        const snap = await getDocs(q);
                        galleryItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderGalleryCards(galleryItems);
                        renderFilterButtons(galleryItems);
                    } catch (err) { console.error('Błąd ładowania galerii:', err); empty.textContent = 'Nie udało się wczytać galerii.'; grid.innerHTML = ''; }
                    finally { grid.setAttribute('aria-busy', 'false'); }
                }

                lbClose.addEventListener('click', closeLightbox);
                lbPrev.addEventListener('click', showPrev);
                lbNext.addEventListener('click', showNext);
                lightbox.addEventListener('click', e => { if (e.target === lightbox) closeLightbox(); });
                window.addEventListener('keydown', (e) => { if (!lightbox.classList.contains('open')) return; if (e.key === 'Escape') closeLightbox(); if (e.key === 'ArrowRight') showNext(); if (e.key === 'ArrowLeft') showPrev(); });
                
                loadGalleryData();
            },
            
            renderPiciorys(doc) {
              if (!doc || !doc.exists()) return SectionLoader.render.renderEmpty("Brak danych dla Piciorysu.");
              const entry = doc.data(); const { escapeHtml } = SectionLoader.utils; const introText = (entry.text || '').split('---PODZIAL---')[0] || "Brak tekstu wstępu."; const mainText = (entry.text || '').split('---PODZIAL---')[1] || "Brak tekstu głównego.";
              const html = `<div class="log-container" data-doc-id="${doc.id}"><div id="piciorys-intro" data-text="${escapeHtml(introText)}"><h2 class="log-title">${escapeHtml(entry.introTitle || "Nazywam się Alkohol")}</h2><div class="log-content" id="intro-content-target"></div><div class="log-actions"><button class="action-button" data-action="lector-play-pause" data-target="piciorys-intro"><i class="fas fa-play"></i> Odsłuchaj</button><button id="continue-btn" class="action-button"><i class="fas fa-book-open"></i> Czytaj dalej</button></div></div><div id="piciorys-main" style="display: none;" data-text="${escapeHtml(mainText)}"><hr class="piciorys-separator"><h2 class="log-title">${escapeHtml(entry.mainTitle || "Piciorys Chudego")}</h2><div class="log-meta"><span><i class="fas fa-eye"></i> ${entry.views || 0}</span><span data-likes-counter><i class="fas fa-heart"></i> Polubienia: ${entry.likes || 0}</span></div><div class="log-content" id="main-content-target"></div><div class="log-actions"><button class="action-button" data-action="lector-play-pause" data-target="piciorys-main"><i class="fas fa-play"></i> Odsłuchaj</button><button class="action-button" data-action="like"><i class="fas fa-heart"></i> Lubię to</button></div></div></div>`;
              SectionLoader.elements.wrapper.innerHTML = html;
              SectionLoader.modules.typewriter.start(document.getElementById('intro-content-target'), introText);
              document.getElementById('continue-btn').addEventListener('click', () => { lektor.stop(); document.querySelector('[data-action="lector-play-pause"][data-target="piciorys-intro"]').innerHTML = `<i class="fas fa-play"></i> Odsłuchaj`; SectionLoader.state.currentLectorTarget = null; document.getElementById('piciorys-intro').style.display = 'none'; document.getElementById('piciorys-main').style.display = 'block'; SectionLoader.modules.typewriter.start(document.getElementById('main-content-target'), mainText); SectionLoader.incrementViews(doc.id); }, { once: true });
            },

            renderKsiezniczka(doc) {
                if (!doc || !doc.exists()) return SectionLoader.render.renderEmpty();
                const entry = doc.data(); const fullText = escapeHtml(`${entry.title || ''}. ${entry.text || ''}`);
                const html = `<main class="content-container story-container" data-doc-id="${doc.id}" data-text="${fullText}"><h2 class="fancy-title">Z punktu widzenia księżniczki</h2><article class="story-item"><h3>${SectionLoader.utils.escapeHtml(entry.title || '')}</h3><div>${entry.text || ''}</div><button class="action-button" data-action="lector-play-pause" data-target="${doc.id}"><i class="fas fa-volume-up"></i> Odsłuchaj</button></article></main>`;
                SectionLoader.elements.wrapper.innerHTML = html;
            },

            renderPomoc(docs) { SectionLoader.elements.wrapper.innerHTML = "<h2>Pomoc - w budowie</h2>"; },

            renderStandard(docs) {
              if (!docs || docs.length === 0) return SectionLoader.render.renderEmpty();
              const { escapeHtml, stripHtml } = SectionLoader.utils;
              const items = docs.map(doc => {
                const e = doc.data();
                const fullContentForLector = escapeHtml(`${e.title || ''}. ${stripHtml(e.text || '')}`);
                const fullContentForDisplay = e.text || '';
                const excerpt = stripHtml(fullContentForDisplay).substring(0, 300) + (fullContentForDisplay.length > 300 ? '...' : '');

                return `
                  <article class="story-item" data-doc-id="${doc.id}" data-text="${fullContentForLector}">
                    <h3 class="entry-title">${escapeHtml(e.title || 'Bez tytułu')}</h3>
                    <div class="entry-meta">
                      <span><i class="fas fa-user-edit"></i> Autor: ${escapeHtml(e.author || 'Chudy')}</span>
                      <span><i class="fas fa-calendar-alt"></i> ${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : 'Brak daty'}</span>
                      <span data-likes-counter><i class="fas fa-heart"></i> Polubienia: ${e.likes || 0}</span>
                      <span><i class="fas fa-eye"></i> Wyświetlenia: ${e.views || 0}</span>
                    </div>
                    <div class="entry-content">
                        <p>${excerpt}</p>
                        <div class="full-content" style="display: none;">${fullContentForDisplay}</div>
                    </div>
                    <div class="log-actions">
                        <button class="action-button" data-action="read-more">Czytaj Dalej</button>
                        <button class="action-button" data-action="lector-play-pause" data-target="${doc.id}"><i class="fas fa-play"></i> Odsłuchaj</button>
                        <button class="action-button" data-action="like"><i class="fas fa-heart"></i> Lubię to</button>
                    </div>
                  </article>`;
              }).join('');
              const html = `<div class="content-container"><h2 class="fancy-title">${escapeHtml(SectionLoader.state.sectionName)}</h2><div class="story-list">${items}</div></div>`;
              SectionLoader.elements.wrapper.innerHTML = html;
              docs.forEach(doc => SectionLoader.incrementViews(doc.id));
            },

            renderError(title, message) { SectionLoader.elements.wrapper.innerHTML = `<div class="content-container"><h2 class="fancy-title">${title}</h2><p>${message}</p></div>`; },
            renderEmpty(message = "Brak wpisów w tej sekcji.") { SectionLoader.render.renderError(SectionLoader.state.sectionName, message); }
        },

        modules: {
            typewriter: {
                start(element, text, speed = 30) {
                    if (!element || !text) { if (element) element.innerHTML = "(Brak tekstu)"; return; }
                    let i = 0; element.innerHTML = '<span class="typing-cursor"></span>';
                    function type() { if (i < text.length) { element.innerHTML = text.substring(0, i + 1).replace(/\n/g, '<br>') + '<span class="typing-cursor"></span>'; i++; setTimeout(type, speed); } else { element.innerHTML = text.replace(/\n/g, '<br>'); } }
                    type();
                }
            }
        }
    };

    document.addEventListener("DOMContentLoaded", () => SectionLoader.init());
  </script>
</body>
</html>

