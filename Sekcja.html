<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer-when-downgrade">
  
  <meta property="og:title" content="Latarnia Nadziei">
  <meta property="og:description" content="Wsparcie w trze≈∫wieniu. Od dna do ≈õwiat≈Ça.">
  <meta property="og:image" content="https://latarnia-nadzieji.vercel.app/logo.png">
  <meta property="og:type" content="website">

  <title>Latarnia Nadziei</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ∞Ô∏è</text></svg>">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    /* =========================================
       STYLIZACJA PREMIUM (Latarnia Vigor Style)
       ========================================= */
    
    html, body { 
        min-height: 100vh; margin: 0; padding: 0; 
        background-color: #0f1014; /* G≈Çƒôboka czer≈Ñ/granat */
        background-image: radial-gradient(circle at 50% 0%, #1f222e 0%, #0f1014 80%);
        color: #e0e0e0; 
        font-family: 'Montserrat', sans-serif; 
        overflow-x: hidden;
    }

    /* TYPOGRAFIA */
    h1, h2, h3 { 
        color: #ffd97b; 
        font-family: 'Cinzel', serif; 
        text-transform: uppercase; 
        letter-spacing: 1px;
        text-shadow: 0 2px 10px rgba(255, 217, 123, 0.2);
        margin-top: 0;
    }
    p { line-height: 1.6; font-size: 1rem; color: #ccc; }

    /* ≈ÅADOWANIE */
    .loading-spinner { 
        border: 4px solid rgba(255, 217, 123, 0.1); 
        border-left-color: #ffd97b; 
        border-radius: 50%; 
        width: 60px; height: 60px; 
        animation: spin 1s linear infinite; 
        margin: 150px auto; 
        box-shadow: 0 0 20px rgba(255, 217, 123, 0.1);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* KONTENER G≈Å√ìWNY */
    #content-wrapper { 
        padding-top: 90px; 
        padding-bottom: 120px; 
        min-height: 100vh;
        box-sizing: border-box;
        animation: fadeIn 0.8s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* PRZYCISK POWROTU (Szklany) */
    .back-btn {
        position: fixed; top: 20px; left: 20px; z-index: 1001;
        background: rgba(0, 0, 0, 0.6);
        color: #ffd97b;
        padding: 12px 20px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        border: 1px solid rgba(255, 217, 123, 0.3);
        backdrop-filter: blur(8px);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; align-items: center; gap: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .back-btn:hover {
        background: rgba(255, 217, 123, 0.15);
        color: #fff;
        border-color: #ffd97b;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 217, 123, 0.2);
    }

    /* KARTY I KONTENERY (Glassmorphism) */
    .story-item, .card, .log-container, .audio-wrap, .support-wrap {
        max-width: 850px;
        margin: 0 auto 30px auto;
        background: rgba(30, 34, 45, 0.6); /* P√≥≈Çprzezroczyste t≈Ço */
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 30px;
        backdrop-filter: blur(12px); /* Rozmycie t≈Ça pod spodem */
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    /* Efekt hover na kartach (tylko na li≈õcie) */
    .story-item:hover, .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        border-color: rgba(255, 217, 123, 0.2);
    }

    /* META DANE */
    .entry-meta { 
        display: flex; flex-wrap: wrap; gap: 20px; 
        color: #888; font-size: 0.85rem; margin-bottom: 20px; 
        border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 15px; 
    }
    .entry-meta span { display: flex; align-items: center; gap: 6px; }
    .entry-meta i { color: #ffd97b; filter: drop-shadow(0 0 5px rgba(255,217,123,0.3)); }

    /* PRZYCISKI AKCJI (Gold Gradient & Outline) */
    .log-actions, .card-actions { margin-top: 25px; display: flex; gap: 12px; flex-wrap: wrap; }
    
    .action-button {
        background: transparent;
        border: 1px solid rgba(255, 217, 123, 0.4);
        color: #ffd97b;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex; align-items: center; gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .action-button:hover {
        background: rgba(255, 217, 123, 0.1);
        border-color: #ffd97b;
        transform: translateY(-1px);
        box-shadow: 0 0 15px rgba(255, 217, 123, 0.1);
    }

    /* Wyr√≥≈ºniony przycisk (np. Czytaj dalej) */
    .action-button[data-action="read-more"], 
    .action-button[data-action="like"]:not([disabled]),
    button[type="submit"] {
        background: linear-gradient(135deg, #ffd97b 0%, #b8860b 100%);
        border: none;
        color: #1a1a1a;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .action-button[data-action="read-more"]:hover,
    .action-button[data-action="like"]:not([disabled]):hover,
    button[type="submit"]:hover {
        background: linear-gradient(135deg, #ffedb8 0%, #d4a017 100%);
        box-shadow: 0 0 20px rgba(255, 217, 123, 0.4);
        transform: translateY(-2px);
    }
    
    .action-button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

    /* AUDIO LIST */
    .audio-btn { 
        background: rgba(0,0,0,0.3); 
        border-left: 4px solid #444; 
        padding: 15px 20px; margin-bottom: 12px; border-radius: 8px; 
        cursor: pointer; transition: all 0.2s ease; 
        display: flex; align-items: center; gap: 15px; 
        border: 1px solid rgba(255,255,255,0.05);
    }
    .audio-btn:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); border-color: rgba(255,255,255,0.1); }
    .audio-btn.playing { 
        border-left-color: #ffd97b; 
        background: linear-gradient(90deg, rgba(255,217,123,0.1) 0%, rgba(0,0,0,0) 100%);
    }
    .audio-icon { font-size: 1.5rem; color: #555; min-width: 30px; text-align: center; }
    .audio-btn.playing .audio-icon { color: #ffd97b; animation: pulse 1.5s infinite; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* FORMULARZE */
    input, textarea {
        background: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #fff !important;
        border-radius: 8px !important;
        padding: 12px !important;
        font-family: inherit;
        transition: border 0.3s;
    }
    input:focus, textarea:focus {
        border-color: #ffd97b !important;
        outline: none;
        box-shadow: 0 0 10px rgba(255, 217, 123, 0.1);
    }

  </style>
</head>
<body>
  
  <a href="/index.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Powr√≥t
  </a>
  
  <div id="content-wrapper">
    <div class="loading-spinner"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, limit, doc, updateDoc, increment, addDoc, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- KONFIGURACJA FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyD1kuonCrsLNV4ObBiI2jsqdnGx3vaA9_Q",
      authDomain: "projekt-latarnia.firebaseapp.app",
      projectId: "projekt-latarnia",
      storageBucket: "projekt-latarnia.firebasestorage.app",
      messagingSenderId: "244008044225",
      appId: "1:244008044225:web:67fbc7f5cfa89b627fb640",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const HYMN_URL = "/audio/hymn.mp3"; 

    // ========================================
    // MODU≈Å 1: MusicPlayer (HYMN)
    // ========================================
    const MusicPlayer = (() => {
        let audio = null;
        let isPlaying = false;
        let btnElement = null;

        const init = () => {
            // Styl przycisku Hymnu (Przywr√≥cony piƒôkny 3D)
            const style = document.createElement('style');
            style.innerHTML = `
                .hymn-wrapper { position: fixed; bottom: 30px; right: 30px; z-index: 99999; display: flex; flex-direction: column; align-items: center; gap: 10px; }
                .hymn-btn-3d { 
                    position: relative; width: 70px; height: 70px; border-radius: 50%; border: none; 
                    background: linear-gradient(145deg, #ffd97b, #c5a059); 
                    box-shadow: 0 6px 0 #8c7035, 0 10px 20px rgba(0,0,0,0.4); 
                    cursor: pointer; display: flex; justify-content: center; align-items: center; 
                    font-size: 28px; color: #1a1a1a; outline: none; transition: transform 0.1s; 
                }
                .hymn-btn-3d:active { transform: translateY(6px); box-shadow: 0 0 0 #8c7035, inset 0 4px 10px rgba(0,0,0,0.3); }
                .hymn-label { 
                    background: rgba(0,0,0,0.9); color: #ffd97b; padding: 5px 10px; border-radius: 6px; 
                    font-size: 0.8rem; text-transform:uppercase; letter-spacing:1px; opacity: 0; 
                    transition: opacity 0.3s; pointer-events: none; border: 1px solid #ffd97b;
                }
                .hymn-wrapper:hover .hymn-label { opacity: 1; }
                .pulse-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; animation: pulse-gold 2s infinite; z-index: -1; display: none; }
                @keyframes pulse-gold { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 217, 123, 0.6); } 100% { transform: scale(1.6); box-shadow: 0 0 0 30px rgba(255, 217, 123, 0); } }
            `;
            document.head.appendChild(style);

            const wrapper = document.createElement('div');
            wrapper.className = 'hymn-wrapper';
            wrapper.innerHTML = `<span class="hymn-label">Hymn</span><div class="pulse-ring" id="hymn-pulse"></div><button class="hymn-btn-3d" id="hymn-btn"><i class="fas fa-music"></i></button>`;
            document.body.appendChild(wrapper);

            btnElement = document.getElementById('hymn-btn');
            btnElement.addEventListener('click', togglePlay);
        };

        const togglePlay = () => { isPlaying ? stop() : play(); };

        const play = () => {
            if (!audio) {
                audio = new Audio(HYMN_URL);
                audio.loop = true;
            }
            if (typeof lektor !== 'undefined') lektor.stop();
            const hiddenPlayer = document.getElementById('hiddenPlayer');
            if (hiddenPlayer) hiddenPlayer.pause();
            
            document.querySelectorAll('[data-action="lector-play-pause"]').forEach(btn => btn.innerHTML = `<i class="fas fa-play"></i> Ods≈Çuchaj`);

            audio.play().then(() => { isPlaying = true; updateUI(true); })
                 .catch(e => { console.error(e); alert("Nie mo≈ºna odtworzyƒá hymnu (sprawd≈∫ plik /audio/hymn.mp3)"); });
        };

        const stop = () => { if (!audio) return; audio.pause(); isPlaying = false; updateUI(false); };

        const updateUI = (playing) => {
            const icon = btnElement.querySelector('i');
            const pulse = document.getElementById('hymn-pulse');
            if (playing) { icon.className = 'fas fa-pause'; pulse.style.display = 'block'; }
            else { icon.className = 'fas fa-music'; pulse.style.display = 'none'; }
        };

        return { init, stop, play };
    })();

    // ========================================
    // MODU≈Å 2: Lektor (TTS)
    // ========================================
    const lektor = (() => {
        let queue = [];
        let isPaused = false;
        let selectedVoice = null;
        const synth = window.speechSynthesis;

        const stripHtml = (html) => { 
            const div = document.createElement("div"); 
            div.innerHTML = html; 
            return div.textContent || div.innerText || ""; 
        };
        
        const initVoices = () => { 
            const voices = synth.getVoices(); 
            selectedVoice = voices.find(v => v.lang === "pl-PL") || voices[0]; 
        }; 
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();

        const speakNext = () => { 
            if (isPaused || queue.length === 0) return; 
            if (!selectedVoice) initVoices();

            const text = queue.shift(); 
            const utterance = new SpeechSynthesisUtterance(text); 
            utterance.lang = "pl-PL"; 
            if (selectedVoice) utterance.voice = selectedVoice; 
            utterance.rate = 0.9; 
            utterance.onend = () => { if (!isPaused) speakNext(); }; 
            synth.speak(utterance); 
        };

        const enqueue = (rawText) => { 
            if (!rawText) return; 
            MusicPlayer.stop(); 
            stop(); 
            const clean = stripHtml(rawText);
            const parts = clean.match(/[^.!?]+[.!?]*/g) || [clean];
            queue.push(...parts); 
            speakNext(); 
        };

        const stop = () => { isPaused = false; queue = []; synth.cancel(); };
        const pause = () => { if (synth.speaking) { synth.pause(); isPaused = true; } };
        const resume = () => { if (isPaused) { isPaused = false; synth.resume(); } };
        const getStatus = () => ({ speaking: synth.speaking, paused: isPaused });
        
        return { enqueue, stop, pause, resume, getStatus };
    })();

    // ========================================
    // MODU≈Å 3: SectionLoader (G≈Å√ìWNY SILNIK)
    // ========================================
    const SectionLoader = {
        state: { sectionName: '', cleanupFunctions: [] },
        elements: { wrapper: document.getElementById('content-wrapper') },
        utils: {
            escapeHtml: (s) => String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])),
            stripHtml: (s) => String(s).replace(/<[^>]*>?/gm, ''),
            getLikedPosts: () => JSON.parse(localStorage.getItem('latarniaLikedPosts') || '[]'),
            addLikedPost: (id) => { const l = JSON.parse(localStorage.getItem('latarniaLikedPosts') || '[]'); if(!l.includes(id)) { l.push(id); localStorage.setItem('latarniaLikedPosts', JSON.stringify(l)); }}
        },
        router: {
            'G≈Ços Latarni': { fetcher: 'fetchNoOp', renderer: 'renderAudioSection', theme: 'theme-audio' },
            'Piciorys Chudego': { fetcher: 'fetchSingleEntry', renderer: 'renderPiciorys', theme: 'theme-piciorys' },
            'Z punktu widzenia ksiƒô≈ºniczki': { fetcher: 'fetchSingleEntry', renderer: 'renderKsiezniczka', theme: 'theme-ksiezniczka' },
            'Pomoc': { fetcher: 'fetchAllHelpEntries', renderer: 'renderPomoc', theme: 'theme-pomoc' },
            'Wsparcie': { fetcher: 'fetchNoOp', renderer: 'renderSupportSection', theme: 'theme-support' },
            'Galeria': { fetcher: 'fetchNoOp', renderer: 'renderGallery', theme: 'theme-gallery' },
            '__default__': { fetcher: 'fetchAllEntries', renderer: 'renderStandard', queryOptions: [orderBy('createdAt', 'desc')], theme: 'theme-kronika' }
        },

        async init() {
            MusicPlayer.init();
            
            this.state.cleanupFunctions.forEach(c => c());
            this.state.cleanupFunctions = [];
            this.setupEventListeners();
            
            try {
                const params = new URLSearchParams(window.location.search);
                this.state.sectionName = decodeURIComponent(params.get('nazwa') || 'Kronika').trim();
                
                const route = this.router[this.state.sectionName] || this.router['__default__'];
                document.title = `${this.utils.escapeHtml(this.state.sectionName)} ‚Äî Latarnia Nadziei`;
                
                const data = await this.fetch[route.fetcher].call(this, route.queryOptions);
                this.render[route.renderer].call(this, data);
            } catch (e) {
                console.error(e);
                this.render.renderError('B≈ÇƒÖd', 'Nie uda≈Ço siƒô wczytaƒá sekcji. Sprawd≈∫ po≈ÇƒÖczenie.');
            }
        },

        setupEventListeners() {
            this.elements.wrapper.addEventListener('click', async (event) => {
                const btn = event.target.closest('[data-action]');
                if (!btn) return;
                
                const action = btn.dataset.action;
                const docId = btn.closest('[data-doc-id]')?.dataset.docId;

                // LAJKOWANIE
                if (action === 'like' && docId) {
                    if(btn.disabled || this.utils.getLikedPosts().includes(docId)) return;
                    btn.disabled = true;
                    try {
                        const col = this.state.sectionName === 'Wsparcie' ? 'support_stories' : `sekcje/${this.state.sectionName}/entries`;
                        await updateDoc(doc(db, col, docId), { likes: increment(1) });
                        this.utils.addLikedPost(docId);
                        
                        btn.innerHTML = `<i class="fas fa-check"></i> Polubiono`;
                        const counter = btn.closest('article, .log-container, .card').querySelector('[data-likes-counter]');
                        if(counter) {
                            const current = parseInt(counter.innerText.match(/\d+/)) || 0;
                            counter.innerHTML = `<i class="fas fa-heart"></i> ${current + 1}`;
                        }
                    } catch(e) { console.error(e); btn.disabled = false; }
                } 
                // ROZWIJANIE
                else if (action === 'read-more') {
                    const content = btn.closest('.story-item').querySelector('.full-content');
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    btn.textContent = isHidden ? 'Ukryj' : 'Czytaj Dalej';
                    
                    if(isHidden && docId) { 
                        try { await updateDoc(doc(db, `sekcje/${this.state.sectionName}/entries`, docId), { views: increment(1) }); } catch(e){} 
                    }
                }
                // LEKTOR
                else if (action === 'lector-play-pause') {
                    const status = lektor.getStatus();
                    if(status.speaking && !status.paused) { 
                        lektor.pause(); 
                        btn.innerHTML = `<i class="fas fa-play"></i> Wzn√≥w`; 
                    }
                    else if(status.paused) { 
                        lektor.resume(); 
                        btn.innerHTML = `<i class="fas fa-pause"></i> Pauza`; 
                    }
                    else {
                        document.querySelectorAll('[data-action="lector-play-pause"]').forEach(b => b.innerHTML = `<i class="fas fa-play"></i> Ods≈Çuchaj`);
                        const container = btn.closest('[data-text]');
                        if(container) {
                            lektor.enqueue(container.dataset.text);
                            btn.innerHTML = `<i class="fas fa-pause"></i> Pauza`;
                        }
                    }
                }
            });
        },

        fetch: {
            async fetchNoOp() { return null; },
            async fetchSingleEntry() { 
                const q = query(collection(db, 'sekcje', SectionLoader.state.sectionName, 'entries'), limit(1)); 
                const s = await getDocs(q); 
                return s.empty ? null : s.docs[0]; 
            },
            async fetchAllEntries(opts) { 
                const s = await getDocs(query(collection(db, `sekcje/${SectionLoader.state.sectionName}/entries`), ...opts)); 
                return s.docs; 
            },
            async fetchAllHelpEntries() { return []; }
        },

        render: {
            // RENDER: G≈ÅOS LATARNI (Audio)
            async renderAudioSection() {
                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="audio-wrap">
                        <header style="margin-bottom:40px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                            <h1>G≈Ços Latarni</h1>
                            <p style="color:rgba(255,255,255,0.7);">Pos≈Çuchaj, je≈õli nie masz si≈Çy czytaƒá.</p>
                        </header>
                        <div id="audioCategories"><i class="fas fa-spinner fa-spin"></i> ≈Åadowanie biblioteki...</div>
                        <audio id="hiddenPlayer" style="display:none;"></audio>
                    </div>`;
                
                const container = document.getElementById('audioCategories');
                const player = document.getElementById('hiddenPlayer');
                let currentBtn = null;

                const q = query(collection(db, 'audio_tracks'), where('active', '==', true), orderBy('category'), orderBy('order'));
                SectionLoader.state.cleanupFunctions.push(onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) { container.innerHTML = 'Brak nagra≈Ñ.'; return; }
                    
                    const grouped = {};
                    snapshot.docs.forEach(d => {
                        const t = d.data();
                        const cat = t.category || 'inne';
                        if(!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(t);
                    });

                    container.innerHTML = '';
                    const catNames = { 'ratunek': 'üÜò Ratunek Teraz', 'medytacje': 'üßò Medytacje', 'wiedza': 'üß† Wiedza', 'historie': 'üî• Historie' };

                    for (const [cat, items] of Object.entries(grouped)) {
                        const sec = document.createElement('div');
                        sec.innerHTML = `<h2 style="color:#fff; opacity:0.5; font-size:1rem; text-transform:uppercase; border-left:3px solid #ffd97b; padding-left:15px; margin-top:40px; margin-bottom:20px;">${catNames[cat] || cat}</h2>`;
                        items.forEach(track => {
                            const btn = document.createElement('div');
                            btn.className = 'audio-btn';
                            btn.innerHTML = `
                                <div class="audio-icon"><i class="fas fa-play"></i></div>
                                <div>
                                    <div style="font-weight:bold; color:#e0e0e0; font-size:1.1rem;">${SectionLoader.utils.escapeHtml(track.title)}</div>
                                    <div style="font-size:0.9rem; color:#888;">${SectionLoader.utils.escapeHtml(track.description||'')}</div>
                                </div>`;
                            
                            btn.onclick = () => {
                                if(currentBtn === btn && !player.paused) {
                                    player.pause(); 
                                    btn.classList.remove('playing'); 
                                    btn.querySelector('i').className = 'fas fa-play';
                                } else {
                                    if(currentBtn) { 
                                        currentBtn.classList.remove('playing'); 
                                        currentBtn.querySelector('i').className = 'fas fa-play'; 
                                    }
                                    MusicPlayer.stop(); if(typeof lektor!=='undefined') lektor.stop();
                                    player.src = track.url; player.play();
                                    currentBtn = btn; 
                                    btn.classList.add('playing'); 
                                    btn.querySelector('i').className = 'fas fa-stop';
                                }
                            };
                            sec.appendChild(btn);
                        });
                        container.appendChild(sec);
                    }
                }));
                player.onended = () => { if(currentBtn) { currentBtn.classList.remove('playing'); currentBtn.querySelector('i').className = 'fas fa-play'; } };
            },

            // RENDER: WSPARCIE
            async renderSupportSection() {
                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="support-wrap">
                        <header style="text-align:center; margin-bottom:40px;">
                            <h1 style="font-size:2.5rem;">WSPARCIE</h1>
                            <p>Zostaw dobre s≈Çowo. Ono wraca.</p>
                        </header>
                        
                        <form id="supportForm" style="display:flex; flex-direction:column; gap:20px; margin-bottom:40px;">
                            <input id="supportName" placeholder="Twoje imiƒô / pseudonim" required>
                            <textarea id="supportStory" placeholder="Twoja wiadomo≈õƒá..." style="min-height:120px;" required></textarea>
                            <button type="submit" class="action-button" style="justify-content:center; padding:15px;">OPUBLIKUJ</button>
                        </form>
                        
                        <div id="feed" style="display:flex; flex-direction:column; gap:25px;">
                            <div style="text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> Pobieranie wpis√≥w...</div>
                        </div>
                    </div>`;

                const form = document.getElementById('supportForm');
                const feed = document.getElementById('feed');

                const q = query(collection(db, "support_stories"), where("isApproved", "==", true), orderBy("t", "desc"));
                SectionLoader.state.cleanupFunctions.push(onSnapshot(q, (snapshot) => {
                    feed.innerHTML = '';
                    if(snapshot.empty) { feed.innerHTML = '<p style="text-align:center; color:#888;">Brak wpis√≥w.</p>'; return; }
                    
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const card = document.createElement('article');
                        card.className = 'card';
                        card.dataset.docId = doc.id;
                        card.dataset.text = `${item.name} napisa≈Ç: ${item.text}`;
                        const isLiked = SectionLoader.utils.getLikedPosts().includes(doc.id);
                        
                        card.innerHTML = `
                            <h3 style="margin:0 0 10px 0; font-size:1.3rem;">${SectionLoader.utils.escapeHtml(item.name)}</h3>
                            <p style="color:#ddd; font-size:1.05rem;">${SectionLoader.utils.escapeHtml(item.text)}</p>
                            <div class="entry-meta" style="margin-top:20px;">
                                <span data-likes-counter><i class="fas fa-heart"></i> ${item.likes||0}</span>
                                <span style="font-size:0.8rem; margin-left:auto;">${item.t ? new Date(item.t.toDate()).toLocaleDateString() : 'Teraz'}</span>
                            </div>
                            <div class="card-actions">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Ods≈Çuchaj</button>
                                <button class="action-button" data-action="like" ${isLiked?'disabled':''}><i class="fas fa-heart"></i> ${isLiked?'Dziƒôki!':'Wspieram'}</button>
                            </div>`;
                        feed.appendChild(card);
                    });
                }));

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = form.querySelector('button');
                    btn.disabled = true; btn.innerText = "Wysy≈Çanie...";
                    try {
                        await addDoc(collection(db, "support_stories"), { name: document.getElementById('supportName').value, text: document.getElementById('supportStory').value, t: serverTimestamp(), isApproved: false, likes: 0 });
                        form.reset(); alert("Dziƒôkujemy! Tw√≥j wpis trafi≈Ç do moderacji.");
                    } catch(err) { alert("B≈ÇƒÖd wysy≈Çania."); } 
                    finally { btn.disabled = false; btn.innerText = "OPUBLIKUJ"; }
                });
            },

            // RENDER: PICIORYS
            renderPiciorys(doc) {
                if(!doc) return SectionLoader.render.renderEmpty();
                const e = doc.data();
                const parts = (e.text || '').split('---PODZIAL---');
                const intro = parts[0] || '';
                const main = parts[1] || '';
                const isLiked = SectionLoader.utils.getLikedPosts().includes(doc.id);

                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="log-container" data-doc-id="${doc.id}">
                        <div id="piciorys-intro" data-text="${SectionLoader.utils.escapeHtml(intro)}">
                            <h1 style="font-size:2.2rem; margin-bottom:30px; text-align:center;">${SectionLoader.utils.escapeHtml(e.introTitle || 'PoczƒÖtek')}</h1>
                            <div class="log-content" style="font-size:1.1rem; line-height:1.8;">${intro}</div>
                            <div class="log-actions" style="margin-top:40px; justify-content:center;">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Lektor</button>
                                <button id="continue-btn" class="action-button" style="background: linear-gradient(135deg, #ffd97b 0%, #b8860b 100%); border:none; color:#000;">Czytaj dalej <i class="fas fa-arrow-down"></i></button>
                            </div>
                        </div>
                        <div id="piciorys-main" style="display:none;" data-text="${SectionLoader.utils.escapeHtml(main)}">
                             <hr style="border-color:rgba(255,255,255,0.1); margin:40px 0;">
                             <h2 style="margin-bottom:20px;">${SectionLoader.utils.escapeHtml(e.mainTitle || 'CiƒÖg dalszy')}</h2>
                             <div class="entry-meta"><span><i class="fas fa-eye"></i> ${e.views || 0}</span><span data-likes-counter><i class="fas fa-heart"></i> ${e.likes || 0}</span></div>
                             <div class="log-content" style="font-size:1.1rem; line-height:1.8;">${main}</div>
                             <div class="log-actions" style="margin-top:30px;">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Lektor</button>
                                <button class="action-button" data-action="like" ${isLiked?'disabled':''}><i class="fas fa-heart"></i> ${isLiked?'Polubiono':'Lubiƒô to'}</button>
                             </div>
                        </div>
                    </div>`;
                
                document.getElementById('continue-btn').addEventListener('click', () => {
                    const mainEl = document.getElementById('piciorys-main');
                    document.getElementById('piciorys-intro').style.opacity = '0.5';
                    mainEl.style.display = 'block';
                    mainEl.scrollIntoView({ behavior: 'smooth' });
                    lektor.stop();
                    updateDoc(doc.ref, { views: increment(1) }).catch(()=>{});
                });
            },

            // RENDER: STANDARD
            renderStandard(docs) {
                if (!docs.length) return SectionLoader.render.renderEmpty();
                const html = docs.map(d => {
                    const e = d.data();
                    const plain = SectionLoader.utils.stripHtml(e.text||'');
                    const excerpt = plain.substring(0, 250)+'...';
                    const isLiked = SectionLoader.utils.getLikedPosts().includes(d.id);

                    return `
                    <article class="story-item" data-doc-id="${d.id}" data-text="${SectionLoader.utils.escapeHtml(e.title)}. ${SectionLoader.utils.escapeHtml(plain)}">
                        <h3 style="font-size:1.5rem;">${SectionLoader.utils.escapeHtml(e.title)}</h3>
                        <div class="entry-meta">
                            <span><i class="fas fa-calendar-alt"></i> ${e.createdAt ? e.createdAt.toDate().toLocaleDateString() : '---'}</span>
                            <span data-likes-counter><i class="fas fa-heart"></i> ${e.likes||0}</span>
                            <span><i class="fas fa-eye"></i> ${e.views||0}</span>
                        </div>
                        <div class="entry-content">
                            <p>${excerpt}</p>
                            <div class="full-content" style="display:none; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">${e.text||''}</div>
                        </div>
                        <div class="log-actions">
                            <button class="action-button" data-action="read-more">Czytaj Dalej</button>
                            <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Ods≈Çuchaj</button>
                            <button class="action-button" data-action="like" ${isLiked?'disabled':''}>Lubiƒô to</button>
                        </div>
                    </article>`;
                }).join('');
                
                SectionLoader.elements.wrapper.innerHTML = `
                    <div style="max-width:850px; margin:0 auto; padding:0 20px;">
                        <h1 style="text-align:center; margin-bottom:50px; font-size:2.5rem;">${SectionLoader.state.sectionName}</h1>
                        <div class="story-list">${html}</div>
                    </div>`;
            },
            
            renderEmpty() { SectionLoader.elements.wrapper.innerHTML = `<div style="text-align:center; padding:50px;"><h2>Pusto</h2><p>Brak wpis√≥w.</p></div>`; },
            renderError(t, m) { SectionLoader.elements.wrapper.innerHTML = `<div style="text-align:center; padding:50px; color:#ff6b6b;"><h2>${t}</h2><p>${m}</p></div>`; },
            renderKsiezniczka() { SectionLoader.render.renderError('W budowie', 'Sekcja Ksiƒô≈ºniczki jest przygotowywana.'); },
            renderPomoc() { SectionLoader.render.renderError('W budowie', 'Sekcja Pomocy jest przygotowywana.'); },
            renderGallery() { SectionLoader.render.renderError('W budowie', 'Galeria jest przygotowywana.'); }
        }
    };

    document.addEventListener("DOMContentLoaded", () => SectionLoader.init());
  </script>
</body>
</html>
