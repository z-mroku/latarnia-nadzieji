<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="no-referrer-when-downgrade">
  
  <meta property="og:title" content="Latarnia Nadziei">
  <meta property="og:description" content="Wsparcie w trze≈∫wieniu. Od dna do ≈õwiat≈Ça.">
  <meta property="og:image" content="https://latarnia-nadzieji.vercel.app/logo.png">
  <meta property="og:type" content="website">

  <title>Latarnia Nadziei</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ∞Ô∏è</text></svg>">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    /* --- STYLE KRYTYCZNE DLA SEKCJI --- */
    html, body { min-height: 100vh; margin: 0; padding: 0; background-color: #1a1a1a; color: #fff; font-family: 'Montserrat', sans-serif; }
    
    .loading-spinner { 
        border: 4px solid rgba(255, 255, 255, 0.1); 
        border-left-color: #ffd97b; 
        border-radius: 50%; 
        width: 50px; height: 50px; 
        animation: spin 1s linear infinite; 
        margin: 100px auto; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* PRZYCISK POWROTU */
    .back-btn {
        position: fixed; top: 15px; left: 15px; z-index: 1001;
        background: rgba(0,0,0,0.6);
        color: #ffd97b;
        padding: 10px 15px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
        border: 1px solid rgba(255, 217, 123, 0.3);
        backdrop-filter: blur(5px);
        transition: all 0.3s;
        font-size: 0.9rem;
        display: flex; align-items: center; gap: 8px;
    }
    .back-btn:hover {
        background: rgba(255,217,123,0.2);
        color: #fff;
        transform: translateX(3px);
    }
    
    #content-wrapper { 
        padding-top: 80px; 
        padding-bottom: 100px; 
        min-height: 100vh;
        box-sizing: border-box;
    }

    /* ELEMENTY LISTY */
    .story-item, .card, .log-container {
        max-width: 800px;
        margin: 0 auto 25px auto;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 25px;
        backdrop-filter: blur(10px);
    }

    .entry-meta { 
        display: flex; flex-wrap: wrap; gap: 15px; 
        color: #888; font-size: 0.85rem; margin-bottom: 15px; 
        border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; 
    }
    .entry-meta span { display: flex; align-items: center; gap: 5px; }
    .entry-meta i { color: #ffd97b; }

    /* PRZYCISKI AKCJI */
    .log-actions, .card-actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
    .action-button {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
        display: flex; align-items: center; gap: 6px;
    }
    .action-button:hover { background: rgba(255,217,123,0.2); border-color: #ffd97b; }
    .action-button:disabled { opacity: 0.5; cursor: default; }

    /* AUDIO LIST */
    .audio-btn { 
        background: #151515; border-left: 4px solid #333; 
        padding: 15px; margin-bottom: 10px; border-radius: 6px; 
        cursor: pointer; transition: all 0.2s ease; 
        display: flex; align-items: center; gap: 15px; 
    }
    .audio-btn:hover { background: #222; transform: translateX(5px); }
    .audio-btn.playing { border-left-color: #ffd97b; background: #2a2510; }
    .audio-icon { font-size: 1.5rem; color: #555; min-width: 30px; text-align: center; }
    .audio-btn.playing .audio-icon { color: #ffd97b; }

    /* TYTU≈ÅY */
    h1, h2, h3 { color: #ffd97b; font-family: 'Cinzel', serif; margin-top: 0; }
  </style>
</head>
<body>
  
  <a href="/index.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Powr√≥t
  </a>
  
  <div id="content-wrapper">
    <div class="loading-spinner"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, limit, doc, updateDoc, increment, addDoc, onSnapshot, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- KONFIGURACJA FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyD1kuonCrsLNV4ObBiI2jsqdnGx3vaA9_Q",
      authDomain: "projekt-latarnia.firebaseapp.app",
      projectId: "projekt-latarnia",
      storageBucket: "projekt-latarnia.firebasestorage.app",
      messagingSenderId: "244008044225",
      appId: "1:244008044225:web:67fbc7f5cfa89b627fb640",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const HYMN_URL = "/audio/hymn.mp3"; 

    // ========================================
    // MODU≈Å 1: MusicPlayer (HYMN)
    // ========================================
    const MusicPlayer = (() => {
        let audio = null;
        let isPlaying = false;
        let btnElement = null;

        const init = () => {
            // Styl przycisku Hymnu
            const style = document.createElement('style');
            style.innerHTML = `
                .hymn-wrapper { position: fixed; bottom: 25px; right: 25px; z-index: 99999; display: flex; flex-direction: column; align-items: center; gap: 8px; }
                .hymn-btn-3d { position: relative; width: 60px; height: 60px; border-radius: 50%; border: none; background: linear-gradient(145deg, #ffd97b, #c5a059); box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #222; outline: none; transition: transform 0.1s; }
                .hymn-btn-3d:active { transform: scale(0.95); }
                .hymn-label { background: rgba(0,0,0,0.8); color: #ffd97b; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
                .hymn-wrapper:hover .hymn-label { opacity: 1; }
                .pulse-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; animation: pulse-gold 2s infinite; z-index: -1; display: none; }
                @keyframes pulse-gold { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 217, 123, 0.6); } 100% { transform: scale(1.5); box-shadow: 0 0 0 20px rgba(255, 217, 123, 0); } }
            `;
            document.head.appendChild(style);

            const wrapper = document.createElement('div');
            wrapper.className = 'hymn-wrapper';
            wrapper.innerHTML = `<span class="hymn-label">Hymn</span><div class="pulse-ring" id="hymn-pulse"></div><button class="hymn-btn-3d" id="hymn-btn"><i class="fas fa-music"></i></button>`;
            document.body.appendChild(wrapper);

            btnElement = document.getElementById('hymn-btn');
            btnElement.addEventListener('click', togglePlay);
        };

        const togglePlay = () => { isPlaying ? stop() : play(); };

        const play = () => {
            if (!audio) {
                audio = new Audio(HYMN_URL);
                audio.loop = true;
            }
            // Zatrzymaj inne audio
            if (typeof lektor !== 'undefined') lektor.stop();
            const hiddenPlayer = document.getElementById('hiddenPlayer');
            if (hiddenPlayer) hiddenPlayer.pause();
            
            // Resetuj ikony lektora
            document.querySelectorAll('[data-action="lector-play-pause"]').forEach(btn => btn.innerHTML = `<i class="fas fa-play"></i> Ods≈Çuchaj`);

            audio.play().then(() => { isPlaying = true; updateUI(true); })
                 .catch(e => { console.error(e); alert("Nie mo≈ºna odtworzyƒá hymnu (sprawd≈∫ plik /audio/hymn.mp3)"); });
        };

        const stop = () => { if (!audio) return; audio.pause(); isPlaying = false; updateUI(false); };

        const updateUI = (playing) => {
            const icon = btnElement.querySelector('i');
            const pulse = document.getElementById('hymn-pulse');
            if (playing) { icon.className = 'fas fa-pause'; pulse.style.display = 'block'; }
            else { icon.className = 'fas fa-music'; pulse.style.display = 'none'; }
        };

        return { init, stop, play };
    })();

    // ========================================
    // MODU≈Å 2: Lektor (TTS)
    // ========================================
    const lektor = (() => {
        let queue = [];
        let isPaused = false;
        let selectedVoice = null;
        const synth = window.speechSynthesis;

        const stripHtml = (html) => { 
            const div = document.createElement("div"); 
            div.innerHTML = html; 
            return div.textContent || div.innerText || ""; 
        };
        
        const initVoices = () => { 
            const voices = synth.getVoices(); 
            selectedVoice = voices.find(v => v.lang === "pl-PL") || voices[0]; 
        }; 
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();

        const speakNext = () => { 
            if (isPaused || queue.length === 0) return; 
            if (!selectedVoice) initVoices();

            const text = queue.shift(); 
            const utterance = new SpeechSynthesisUtterance(text); 
            utterance.lang = "pl-PL"; 
            if (selectedVoice) utterance.voice = selectedVoice; 
            utterance.rate = 0.9; 
            utterance.onend = () => { if (!isPaused) speakNext(); }; 
            synth.speak(utterance); 
        };

        const enqueue = (rawText) => { 
            if (!rawText) return; 
            MusicPlayer.stop(); 
            stop(); 
            const clean = stripHtml(rawText);
            // Dzielimy tekst na zdania, ≈ºeby lektor siƒô nie zacina≈Ç na d≈Çugich blokach
            const parts = clean.match(/[^.!?]+[.!?]*/g) || [clean];
            queue.push(...parts); 
            speakNext(); 
        };

        const stop = () => { isPaused = false; queue = []; synth.cancel(); };
        const pause = () => { if (synth.speaking) { synth.pause(); isPaused = true; } };
        const resume = () => { if (isPaused) { isPaused = false; synth.resume(); } };
        const getStatus = () => ({ speaking: synth.speaking, paused: isPaused });
        
        return { enqueue, stop, pause, resume, getStatus };
    })();

    // ========================================
    // MODU≈Å 3: SectionLoader (G≈Å√ìWNY SILNIK)
    // ========================================
    const SectionLoader = {
        state: { sectionName: '', cleanupFunctions: [] },
        elements: { wrapper: document.getElementById('content-wrapper') },
        utils: {
            escapeHtml: (s) => String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])),
            stripHtml: (s) => String(s).replace(/<[^>]*>?/gm, ''),
            getLikedPosts: () => JSON.parse(localStorage.getItem('latarniaLikedPosts') || '[]'),
            addLikedPost: (id) => { const l = JSON.parse(localStorage.getItem('latarniaLikedPosts') || '[]'); if(!l.includes(id)) { l.push(id); localStorage.setItem('latarniaLikedPosts', JSON.stringify(l)); }}
        },
        router: {
            'G≈Ços Latarni': { fetcher: 'fetchNoOp', renderer: 'renderAudioSection', theme: 'theme-audio' },
            'Piciorys Chudego': { fetcher: 'fetchSingleEntry', renderer: 'renderPiciorys', theme: 'theme-piciorys' },
            'Z punktu widzenia ksiƒô≈ºniczki': { fetcher: 'fetchSingleEntry', renderer: 'renderKsiezniczka', theme: 'theme-ksiezniczka' },
            'Pomoc': { fetcher: 'fetchAllHelpEntries', renderer: 'renderPomoc', theme: 'theme-pomoc' },
            'Wsparcie': { fetcher: 'fetchNoOp', renderer: 'renderSupportSection', theme: 'theme-support' },
            'Galeria': { fetcher: 'fetchNoOp', renderer: 'renderGallery', theme: 'theme-gallery' },
            '__default__': { fetcher: 'fetchAllEntries', renderer: 'renderStandard', queryOptions: [orderBy('createdAt', 'desc')], theme: 'theme-kronika' }
        },

        async init() {
            MusicPlayer.init();
            
            // Czyszczenie poprzednich nas≈Çuchiwaczy (np. przy prze≈Çadowaniu SPA)
            this.state.cleanupFunctions.forEach(c => c());
            this.state.cleanupFunctions = [];
            this.setupEventListeners();
            
            try {
                const params = new URLSearchParams(window.location.search);
                // Domy≈õlnie "Kronika" je≈õli brak parametru
                this.state.sectionName = decodeURIComponent(params.get('nazwa') || 'Kronika').trim();
                
                const route = this.router[this.state.sectionName] || this.router['__default__'];
                document.title = `${this.utils.escapeHtml(this.state.sectionName)} ‚Äî Latarnia Nadziei`;
                
                const data = await this.fetch[route.fetcher].call(this, route.queryOptions);
                this.render[route.renderer].call(this, data);
            } catch (e) {
                console.error(e);
                this.render.renderError('B≈ÇƒÖd', 'Nie uda≈Ço siƒô wczytaƒá sekcji. Sprawd≈∫ po≈ÇƒÖczenie.');
            }
        },

        setupEventListeners() {
            // Jeden g≈Ç√≥wny nas≈Çuchiwacz na wrapper (Delegacja zdarze≈Ñ)
            this.elements.wrapper.addEventListener('click', async (event) => {
                const btn = event.target.closest('[data-action]');
                if (!btn) return;
                
                const action = btn.dataset.action;
                const docId = btn.closest('[data-doc-id]')?.dataset.docId;

                // 1. LAJKOWANIE
                if (action === 'like' && docId) {
                    if(btn.disabled || this.utils.getLikedPosts().includes(docId)) return;
                    btn.disabled = true;
                    try {
                        const col = this.state.sectionName === 'Wsparcie' ? 'support_stories' : `sekcje/${this.state.sectionName}/entries`;
                        await updateDoc(doc(db, col, docId), { likes: increment(1) });
                        this.utils.addLikedPost(docId);
                        
                        btn.innerHTML = `<i class="fas fa-check"></i> Polubiono`;
                        const counter = btn.closest('article, .log-container, .card').querySelector('[data-likes-counter]');
                        if(counter) {
                            const current = parseInt(counter.innerText.match(/\d+/)) || 0;
                            counter.innerHTML = `<i class="fas fa-heart"></i> ${current + 1}`;
                        }
                    } catch(e) { console.error(e); btn.disabled = false; }
                } 
                // 2. CZYTAJ DALEJ (Rozwijanie tekstu)
                else if (action === 'read-more') {
                    const content = btn.closest('.story-item').querySelector('.full-content');
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    btn.textContent = isHidden ? 'Ukryj' : 'Czytaj Dalej';
                    
                    if(isHidden && docId) { 
                        // Zlicz wy≈õwietlenie tylko raz na sesjƒô (uproszczone)
                        try { await updateDoc(doc(db, `sekcje/${this.state.sectionName}/entries`, docId), { views: increment(1) }); } catch(e){} 
                    }
                }
                // 3. LEKTOR (Play/Pause)
                else if (action === 'lector-play-pause') {
                    const status = lektor.getStatus();
                    if(status.speaking && !status.paused) { 
                        lektor.pause(); 
                        btn.innerHTML = `<i class="fas fa-play"></i> Wzn√≥w`; 
                    }
                    else if(status.paused) { 
                        lektor.resume(); 
                        btn.innerHTML = `<i class="fas fa-pause"></i> Pauza`; 
                    }
                    else {
                        // Reset innych przycisk√≥w lektora
                        document.querySelectorAll('[data-action="lector-play-pause"]').forEach(b => b.innerHTML = `<i class="fas fa-play"></i> Ods≈Çuchaj`);
                        
                        // Pobierz tekst z atrybutu data-text
                        const container = btn.closest('[data-text]');
                        if(container) {
                            lektor.enqueue(container.dataset.text);
                            btn.innerHTML = `<i class="fas fa-pause"></i> Pauza`;
                        }
                    }
                }
            });
        },

        // --- FETCHERS (Pobieranie danych) ---
        fetch: {
            async fetchNoOp() { return null; },
            async fetchSingleEntry() { 
                const q = query(collection(db, 'sekcje', SectionLoader.state.sectionName, 'entries'), limit(1)); 
                const s = await getDocs(q); 
                return s.empty ? null : s.docs[0]; 
            },
            async fetchAllEntries(opts) { 
                const s = await getDocs(query(collection(db, `sekcje/${SectionLoader.state.sectionName}/entries`), ...opts)); 
                return s.docs; 
            },
            async fetchAllHelpEntries() { 
                // Placeholder dla sekcji Pomoc
                return []; 
            }
        },

        // --- RENDERERS (Wy≈õwietlanie) ---
        render: {
            
            // --- G≈ÅOS LATARNI (Audio Player) ---
            async renderAudioSection() {
                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="audio-wrap" style="max-width:800px; margin:0 auto; padding:20px;">
                        <header style="margin-bottom:40px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:20px;">
                            <h1 style="color:#ffd97b; text-transform:uppercase;">G≈Ços Latarni</h1>
                            <p style="color:rgba(255,255,255,0.7);">Pos≈Çuchaj, je≈õli nie masz si≈Çy czytaƒá.</p>
                        </header>
                        <div id="audioCategories"><i class="fas fa-spinner fa-spin"></i> ≈Åadowanie biblioteki...</div>
                        <audio id="hiddenPlayer" style="display:none;"></audio>
                    </div>`;
                
                const container = document.getElementById('audioCategories');
                const player = document.getElementById('hiddenPlayer');
                let currentBtn = null;

                const q = query(collection(db, 'audio_tracks'), where('active', '==', true), orderBy('category'), orderBy('order'));
                
                // Real-time listener dla audio
                SectionLoader.state.cleanupFunctions.push(onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) { container.innerHTML = 'Brak nagra≈Ñ.'; return; }
                    
                    // Grupowanie utwor√≥w
                    const grouped = {};
                    snapshot.docs.forEach(d => {
                        const t = d.data();
                        const cat = t.category || 'inne';
                        if(!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(t);
                    });

                    container.innerHTML = '';
                    const catNames = { 'ratunek': 'üÜò Ratunek Teraz', 'medytacje': 'üßò Medytacje', 'wiedza': 'üß† Wiedza', 'historie': 'üî• Historie' };

                    for (const [cat, items] of Object.entries(grouped)) {
                        const sec = document.createElement('div');
                        sec.innerHTML = `<h2 style="color:#fff; opacity:0.5; font-size:0.9rem; text-transform:uppercase; border-left:3px solid #ffd97b; padding-left:10px; margin-top:30px;">${catNames[cat] || cat}</h2>`;
                        
                        items.forEach(track => {
                            const btn = document.createElement('div');
                            btn.className = 'audio-btn';
                            btn.innerHTML = `
                                <div class="audio-icon"><i class="fas fa-play"></i></div>
                                <div>
                                    <div style="font-weight:bold; color:#e0e0e0;">${SectionLoader.utils.escapeHtml(track.title)}</div>
                                    <div style="font-size:0.85rem; color:#888;">${SectionLoader.utils.escapeHtml(track.description||'')}</div>
                                </div>`;
                            
                            btn.onclick = () => {
                                // Pauza je≈õli ten sam utw√≥r gra
                                if(currentBtn === btn && !player.paused) {
                                    player.pause(); 
                                    btn.classList.remove('playing'); 
                                    btn.querySelector('i').className = 'fas fa-play';
                                } else {
                                    // Stop poprzedniego
                                    if(currentBtn) { 
                                        currentBtn.classList.remove('playing'); 
                                        currentBtn.querySelector('i').className = 'fas fa-play'; 
                                    }
                                    MusicPlayer.stop(); 
                                    if(typeof lektor!=='undefined') lektor.stop();
                                    
                                    // Start nowego
                                    player.src = track.url; 
                                    player.play();
                                    currentBtn = btn; 
                                    btn.classList.add('playing'); 
                                    btn.querySelector('i').className = 'fas fa-stop';
                                }
                            };
                            sec.appendChild(btn);
                        });
                        container.appendChild(sec);
                    }
                }));
                
                player.onended = () => { 
                    if(currentBtn) { 
                        currentBtn.classList.remove('playing'); 
                        currentBtn.querySelector('i').className = 'fas fa-play'; 
                    } 
                };
            },

            // --- WSPARCIE (Formularz + Lista) ---
            async renderSupportSection() {
                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="support-wrap" style="max-width:800px; margin:0 auto; padding:20px;">
                        <header style="text-align:center; margin-bottom:40px;">
                            <h1 style="color:#ffd97b; font-size:2.5rem;">WSPARCIE</h1>
                            <p>Zostaw dobre s≈Çowo. Ono wraca.</p>
                        </header>
                        
                        <form id="supportForm" style="background:rgba(255,255,255,0.05); padding:20px; border-radius:10px; display:flex; flex-direction:column; gap:15px; border:1px solid rgba(255,255,255,0.1);">
                            <input id="supportName" placeholder="Twoje imiƒô / pseudonim" style="padding:15px; background:rgba(0,0,0,0.3); border:1px solid #444; color:#fff; border-radius:8px;" required>
                            <textarea id="supportStory" placeholder="Twoja wiadomo≈õƒá..." style="padding:15px; background:rgba(0,0,0,0.3); border:1px solid #444; color:#fff; min-height:100px; border-radius:8px;" required></textarea>
                            <button type="submit" style="padding:15px; background:#ffd97b; border:none; cursor:pointer; font-weight:bold; border-radius:8px; text-transform:uppercase;">Opublikuj</button>
                        </form>
                        
                        <div id="feed" style="margin-top:40px; display:flex; flex-direction:column; gap:20px;">
                            <div style="text-align:center; color:#666;"><i class="fas fa-spinner fa-spin"></i> Pobieranie wpis√≥w...</div>
                        </div>
                    </div>`;

                const form = document.getElementById('supportForm');
                const feed = document.getElementById('feed');

                // Pobieranie post√≥w (Real-time)
                const q = query(collection(db, "support_stories"), where("isApproved", "==", true), orderBy("t", "desc"));
                
                SectionLoader.state.cleanupFunctions.push(onSnapshot(q, (snapshot) => {
                    feed.innerHTML = '';
                    if(snapshot.empty) {
                        feed.innerHTML = '<p style="text-align:center; color:#888;">Brak wpis√≥w. BƒÖd≈∫ pierwszy!</p>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const card = document.createElement('article');
                        card.className = 'card';
                        card.dataset.docId = doc.id;
                        card.dataset.text = `${item.name} napisa≈Ç: ${item.text}`;
                        
                        // Sprawd≈∫ czy polubione lokalnie
                        const isLiked = SectionLoader.utils.getLikedPosts().includes(doc.id);
                        
                        card.innerHTML = `
                            <h3 style="color:#ffd97b; margin:0 0 10px 0; font-size:1.2rem;">${SectionLoader.utils.escapeHtml(item.name)}</h3>
                            <p style="line-height:1.6;">${SectionLoader.utils.escapeHtml(item.text)}</p>
                            <div class="entry-meta" style="margin-top:15px;">
                                <span data-likes-counter><i class="fas fa-heart"></i> ${item.likes||0}</span>
                                <span style="font-size:0.8rem; margin-left:auto;">${item.t ? new Date(item.t.toDate()).toLocaleDateString() : 'Teraz'}</span>
                            </div>
                            <div class="card-actions">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Ods≈Çuchaj</button>
                                <button class="action-button" data-action="like" ${isLiked?'disabled':''}><i class="fas fa-heart"></i> ${isLiked?'Dziƒôki!':'Wspieram'}</button>
                            </div>`;
                        feed.appendChild(card);
                    });
                }));

                // Wysy≈Çanie formularza
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const btn = form.querySelector('button');
                    btn.disabled = true; btn.innerText = "Wysy≈Çanie...";
                    
                    const name = document.getElementById('supportName').value;
                    const text = document.getElementById('supportStory').value;
                    
                    try {
                        await addDoc(collection(db, "support_stories"), { 
                            name, text, t: serverTimestamp(), isApproved: false, likes: 0 
                        });
                        form.reset(); 
                        alert("Dziƒôkujemy! Tw√≥j wpis trafi≈Ç do moderacji i wkr√≥tce siƒô pojawi.");
                    } catch(err) { 
                        console.error(err);
                        alert("B≈ÇƒÖd wysy≈Çania. Spr√≥buj ponownie."); 
                    } finally {
                        btn.disabled = false; btn.innerText = "OPUBLIKUJ";
                    }
                });
            },

            // --- PICIORYS (Intro + Main) ---
            renderPiciorys(doc) {
                if(!doc) return SectionLoader.render.renderEmpty();
                const e = doc.data();
                
                // Dzielenie tekstu na Intro i Main
                const parts = (e.text || '').split('---PODZIAL---');
                const intro = parts[0] || '';
                const main = parts[1] || '';
                const isLiked = SectionLoader.utils.getLikedPosts().includes(doc.id);

                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="log-container" data-doc-id="${doc.id}" style="max-width:800px; margin:0 auto;">
                        
                        <div id="piciorys-intro" data-text="${SectionLoader.utils.escapeHtml(intro)}">
                            <h1 style="color:#ffd97b; font-size:2rem; margin-bottom:20px;">${SectionLoader.utils.escapeHtml(e.introTitle || 'PoczƒÖtek')}</h1>
                            <div class="log-content" style="line-height:1.8; font-size:1.1rem;">${intro}</div>
                            
                            <div class="log-actions" style="margin-top:40px; justify-content:center;">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Lektor</button>
                                <button id="continue-btn" class="action-button" style="background:#ffd97b; color:#000; font-weight:bold;">
                                    Czytaj dalej <i class="fas fa-arrow-down"></i>
                                </button>
                            </div>
                        </div>

                        <div id="piciorys-main" style="display:none;" data-text="${SectionLoader.utils.escapeHtml(main)}">
                             <hr style="border-color:rgba(255,255,255,0.1); margin:40px 0;">
                             <h2 style="color:#ffd97b; margin-bottom:20px;">${SectionLoader.utils.escapeHtml(e.mainTitle || 'CiƒÖg dalszy')}</h2>
                             
                             <div class="entry-meta">
                                <span><i class="fas fa-eye"></i> ${e.views || 0}</span>
                                <span data-likes-counter><i class="fas fa-heart"></i> ${e.likes || 0}</span>
                             </div>

                             <div class="log-content" style="line-height:1.8; font-size:1.1rem;">${main}</div>
                             
                             <div class="log-actions" style="margin-top:30px;">
                                <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Lektor</button>
                                <button class="action-button" data-action="like" ${isLiked?'disabled':''}><i class="fas fa-heart"></i> ${isLiked?'Polubiono':'Lubiƒô to'}</button>
                             </div>
                        </div>
                    </div>`;
                
                // Obs≈Çuga przej≈õcia Intro -> Main
                document.getElementById('continue-btn').addEventListener('click', () => {
                    const introEl = document.getElementById('piciorys-intro');
                    const mainEl = document.getElementById('piciorys-main');
                    
                    introEl.style.opacity = '0.5'; // Przyciemnij wstƒôp
                    mainEl.style.display = 'block'; // Poka≈º resztƒô
                    mainEl.scrollIntoView({ behavior: 'smooth' });
                    
                    lektor.stop(); // Zatrzymaj lektora je≈õli czyta≈Ç wstƒôp
                    
                    // Zlicz wy≈õwietlenie
                    updateDoc(doc.ref, { views: increment(1) }).catch(console.error);
                });
            },

            // --- STANDARD (Lista wpis√≥w - Kronika) ---
            renderStandard(docs) {
                if (!docs.length) return SectionLoader.render.renderEmpty();
                
                const html = docs.map(d => {
                    const e = d.data();
                    const plain = SectionLoader.utils.stripHtml(e.text||'');
                    const excerpt = plain.substring(0, 250)+'...';
                    const isLiked = SectionLoader.utils.getLikedPosts().includes(d.id);

                    return `
                    <article class="story-item" data-doc-id="${d.id}" data-text="${SectionLoader.utils.escapeHtml(e.title)}. ${SectionLoader.utils.escapeHtml(plain)}">
                        <h3 style="color:#ffd97b; font-size:1.4rem;">${SectionLoader.utils.escapeHtml(e.title)}</h3>
                        
                        <div class="entry-meta">
                            <span><i class="fas fa-calendar-alt"></i> ${e.createdAt ? e.createdAt.toDate().toLocaleDateString() : '---'}</span>
                            <span data-likes-counter><i class="fas fa-heart"></i> ${e.likes||0}</span>
                            <span><i class="fas fa-eye"></i> ${e.views||0}</span>
                        </div>
                        
                        <div class="entry-content">
                            <p style="line-height:1.6;">${excerpt}</p>
                            <div class="full-content" style="display:none; margin-top:15px; border-top:1px solid #333; padding-top:15px;">${e.text||''}</div>
                        </div>
                        
                        <div class="log-actions">
                            <button class="action-button" data-action="read-more">Czytaj Dalej</button>
                            <button class="action-button" data-action="lector-play-pause"><i class="fas fa-play"></i> Ods≈Çuchaj</button>
                            <button class="action-button" data-action="like" ${isLiked?'disabled':''}><i class="fas fa-heart"></i> Lubiƒô to</button>
                        </div>
                    </article>`;
                }).join('');
                
                SectionLoader.elements.wrapper.innerHTML = `
                    <div class="content-container" style="max-width:800px; margin:0 auto; padding:20px;">
                        <h1 style="color:#ffd97b; text-align:center; text-transform:uppercase; margin-bottom:40px;">
                            ${SectionLoader.state.sectionName}
                        </h1>
                        <div class="story-list">${html}</div>
                    </div>`;
            },

            // --- POZOSTA≈ÅE ---
            renderEmpty() { 
                SectionLoader.elements.wrapper.innerHTML = `<div style="text-align:center; padding:50px;"><h2>Pusto</h2><p>Brak wpis√≥w w tej sekcji.</p></div>`; 
            },
            renderError(t, m) { 
                SectionLoader.elements.wrapper.innerHTML = `<div style="text-align:center; padding:50px; color:#ff6b6b;"><h2>${t}</h2><p>${m}</p></div>`; 
            },
            // Placeholdery dla brakujƒÖcych sekcji
            renderKsiezniczka() { SectionLoader.render.renderError('W budowie', 'Sekcja Ksiƒô≈ºniczki jest przygotowywana.'); },
            renderPomoc() { SectionLoader.render.renderError('W budowie', 'Sekcja Pomocy jest przygotowywana.'); },
            renderGallery() { SectionLoader.render.renderError('W budowie', 'Galeria jest przygotowywana.'); }
        }
    };

    // START
    document.addEventListener("DOMContentLoaded", () => SectionLoader.init());
  </script>
</body>
</html>
