<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wczytywanie...</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div id="dynamic-content-wrapper">
      <p style="text-align:center; padding-top: 50px;">≈Åadowanie...</p>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const params = new URLSearchParams(location.search);
    const sectionName = (params.get('nazwa') || '').trim();
    const wrapper = document.getElementById('dynamic-content-wrapper');

    // ‚úÖ Naprawiony lektor ‚Äì dzia≈Ça zawsze
    function createLector(buttonId, textElementId, buttonText = "Ods≈Çuchaj") {
        const btn = document.getElementById(buttonId);
        if (!btn) return;
        const textElement = document.getElementById(textElementId);
        if (!textElement) return;
        
        const fullText = (textElement.textContent || textElement.innerText || "").trim();
        if (!fullText) {
            btn.disabled = true;
            btn.style.opacity = 0.5;
            return;
        }

        const sentences = fullText.match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g) || [fullText];
        let currentIndex = 0;
        let isReading = false;

        function readSentence(i) {
            if (!isReading || i >= sentences.length) {
                window.speechSynthesis.cancel();
                isReading = false;
                btn.textContent = `‚ñ∂Ô∏è ${buttonText}`;
                currentIndex = 0;
                return;
            }
            const utterance = new SpeechSynthesisUtterance(sentences[i].trim());
            utterance.lang = "pl-PL";
            utterance.onend = () => { if (isReading) { currentIndex++; readSentence(currentIndex); } };
            window.speechSynthesis.speak(utterance);
        }

        btn.addEventListener("click", () => {
            const synth = window.speechSynthesis;
            if (isReading) {
                isReading = false;
                synth.cancel();
                btn.textContent = `üîÑ Wzn√≥w`;
            } else {
                isReading = true;
                btn.textContent = `‚è∏Ô∏è Pauza`;
                readSentence(currentIndex);
            }
        });
        window.addEventListener("beforeunload", () => window.speechSynthesis.cancel());
    }

    (async () => {
      try {
        if (!sectionName) {
          wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd</h1></header><main><div class="story-container">Brak nazwy sekcji w adresie URL.</div></main>`;
          return;
        }

        document.title = `${sectionName} ‚Äî Od Dna do ≈öwiat≈Ça`;
        const entriesRef = collection(db, 'sekcje', sectionName, 'entries');

        // üìå Specjalne sekcje
        if (sectionName === 'Piciorys Chudego' || sectionName.toLowerCase().includes('ksiƒô≈ºniczki')) {
            const snap = await getDocs(query(entriesRef, limit(1)));
            if (snap.empty) { 
              wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container"><div class="story-item"><p>Brak wpisu w tej sekcji.</p></div></div></main>`; 
              return; 
            }
            const entry = snap.docs[0].data();
            
            if (sectionName === 'Piciorys Chudego') {
                const [quote, historia] = (entry.text || '').split('---PODZIAL---');
                wrapper.innerHTML = `
                <header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
                <main>
                  <article class="newspaper-article">
                    <div id="piciorys-wstep">
                      <h2>${entry.title || ''}</h2>
                      <blockquote>${quote || ''}</blockquote>
                    </div>
                    <div class="speak-button-container">
                      <button id="speakBtn1" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Wstƒôp</button>
                    </div>
                    <div id="piciorys-historia">${historia || ''}</div>
                    <div class="speak-button-container">
                      <button id="speakBtn2" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj Historiƒô</button>
                    </div>
                  </article>
                </main>`;
                createLector("speakBtn1", "piciorys-wstep", "Ods≈Çuchaj Wstƒôp");
                createLector("speakBtn2", "piciorys-historia", "Ods≈Çuchaj Historiƒô");
            } else {
                wrapper.innerHTML = `
                <header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header>
                <main>
                  <div id="ksiezniczka-text">
                    <h2>${entry.title || ''}</h2>
                    ${entry.text || ''}
                  </div>
                  <div class="speak-button-container">
                    <button id="speakBtn" class="speak-button">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                  </div>
                </main>`;
                createLector("speakBtn", "ksiezniczka-text");
            }
        } 
        // üìå Standardowe sekcje (Kronika, Opowie≈õci itd.)
        else { 
            const snap = await getDocs(query(entriesRef, orderBy("createdAt", "desc")));
            if (snap.empty) {
                wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><p>Brak wpis√≥w w tej sekcji.</p></main>`;
                return;
            }

            let entriesHTML = snap.docs.map(doc => {
                const e = doc.data();
                const skrot = e.text.replace(/<[^>]*>?/gm, '').substring(0, 300);
                const contentId = `content-full-${doc.id}`;
                const buttonId = `button-speak-${doc.id}`;
                return `
                    <div class="story-item">
                        <h2>${e.title || 'Bez tytu≈Çu'}</h2>
                        <div class="entry-item-meta">${e.createdAt ? e.createdAt.toDate().toLocaleDateString('pl-PL') : ''}</div>
                        <div class="wpis-skrot"><p>${skrot}...</p></div>
                        <div id="${contentId}" class="wpis-calosc" style="display:none;">${e.text}</div>
                        <div class="speak-button-container">
                            <button class="czytaj-dalej-btn">...czytaj dalej</button>
                            <button id="${buttonId}" class="speak-button" style="display:none;">‚ñ∂Ô∏è Ods≈Çuchaj</button>
                        </div>
                    </div>`;
            }).join('');

            wrapper.innerHTML = `<header class="page-header"><h1>${sectionName}</h1><a href="index.html" class="back-to-home-button">‚üµ Powr√≥t</a></header><main><div class="story-container">${entriesHTML}</div></main>`;

            document.querySelectorAll('.czytaj-dalej-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const storyItem = this.closest('.story-item');
                    const skrot = storyItem.querySelector('.wpis-skrot');
                    const calosc = storyItem.querySelector('.wpis-calosc');
                    const lektorBtn = storyItem.querySelector('.speak-button');
                    const isVisible = calosc.style.display === 'block';

                    if (isVisible) {
                        calosc.style.display = 'none';
                        lektorBtn.style.display = 'none';
                        skrot.style.display = 'block';
                        this.textContent = '...czytaj dalej';
                    } else {
                        calosc.style.display = 'block';
                        lektorBtn.style.display = 'inline-flex';
                        skrot.style.display = 'none';
                        this.textContent = 'Zwi≈Ñ';
                    }
                });
            });

            snap.docs.forEach(doc => {
                const contentId = `content-full-${doc.id}`;
                const buttonId = `button-speak-${doc.id}`;
                createLector(buttonId, contentId);
            });
        }
      } catch (err) {
        console.error("B≈ÇƒÖd krytyczny:", err);
        wrapper.innerHTML = `<header class="page-header"><h1>B≈ÇƒÖd krytyczny</h1></header><main><p>WystƒÖpi≈Ç problem z ≈Çadowaniem sekcji.</p></main>`;
      }
    })();
  </script>
</body>
</html>
