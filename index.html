<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Od Dna do ≈öwiat≈Ça</title>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  .admin-button { position: fixed; top: 15px; right: 15px; z-index: 1001; }
  .read-more-button, .speak-button { margin-top: 8px; display: inline-block; padding: 8px 14px; border-radius: 6px; background:#ffdd00; cursor:pointer; text-decoration:none; }
</style>
</head>
<body>

<a href="login.html" class="admin-button back-to-home-button"><i class="fa-solid fa-satellite-dish"></i> Panel</a>

<header>
  <h1>Od Dna do ≈öwiat≈Ça</h1>
  <div class="scrolling-subtitle-container">
    <p class="special-subtitle">To miejsce dla ubrudzonych ≈ºyciem ‚Äì i dla tych, kt√≥rzy szukajƒÖ ≈õwiat≈Ça</p>
  </div>
</header>

<nav>
  <ul id="main-menu"><li>Wczytywanie menu...</li></ul>
</nav>

<main>
  <div class="animated-warning"><p>‚ÄûDrodzy rodzice, je≈õli wy zaniedbacie i nie nauczycie swoich dzieci, czym i po co sƒÖ uczucia, jak je prze≈ºywaƒá i radziƒá sobie z nimi, zrobi to alkohol ‚Äì bezlito≈õnie i bez skrupu≈Ç√≥w.‚Äù</p></div>

  <div class="spark-container">
    <div id="sparkText" class="spark-text">Wczytywanie iskierki nadziei...</div>
    <button id="sparkButton" class="spark-button">üí´ Daj kolejnƒÖ iskrƒô</button>
  </div>

  <section id="latest-entries" class="content-section">
    <h2 class="fancy-title entries-title">Ostatnia Latarnia Nadziei</h2>
    <div id="entries-container"><p>Wczytywanie wpis√≥w...</p></div>
  </section>

  <section id="comments" class="comments-section">
    <h2>Podziel siƒô swojƒÖ historiƒÖ lub wesprzyj innych</h2>
    <p>Twoje do≈õwiadczenie ma znaczenie. Anonimowo lub nie ‚Äì ka≈ºde s≈Çowo wsparcia jest bezcenne.</p>
    <div id="disqus_thread"></div>
  </section>
</main>

<div class="audio-player">
  <div class="album-art"><i class="fas fa-music"></i></div>
  <div class="player-info">
    <div id="current-song-title">Wczytywanie playlisty...</div>
    <div class="progress-container" id="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
    <div class="player-controls">
      <button id="prev-btn" title="Poprzedni"><i class="fas fa-backward"></i></button>
      <button id="play-pause-btn" title="Odtwarzaj"><i class="fas fa-play"></i></button>
      <button id="next-btn" title="Nastƒôpny"><i class="fas fa-forward"></i></button>
    </div>
  </div>
</div>

<footer>
  <div class="footer-content">
    <span>Od Dna do ≈öwiat≈Ça</span>
    <span>&copy; Chudy</span>
    <span>Kontakt: <a href="mailto:asatro@interia.pl">asatro@interia.pl</a></span>
  </div>
</footer>

<script type="module">
import { db } from './js/firebase-config.js';
import { collection, query, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// === MENU ===
async function loadMenu() {
  const menuEl = document.getElementById('main-menu');
  try {
    const menuSnap = await getDocs(query(collection(db,'menu'),orderBy("order")));
    if(menuSnap.empty) { menuEl.innerHTML='<li>Brak menu</li>'; return; }
    menuEl.innerHTML = menuSnap.docs.map(doc=>{
      const data = doc.data();
      return `<li><a href="${data.link||'#'}">${data.title||'Bez tytu≈Çu'}</a></li>`;
    }).join('');
  } catch(e){ console.error(e); menuEl.innerHTML='<li>B≈ÇƒÖd ≈Çadowania menu</li>'; }
}

// === LATARNIA NADZIEI ===
function createLector(button, textElement) {
  const sentences = (textElement.textContent || '').match(/[^.!?‚Ä¶]+[.!?‚Ä¶]?/g)||[];
  let i=0, reading=false;
  button.addEventListener('click',()=>{
    const synth=window.speechSynthesis;
    if(reading){ synth.cancel(); reading=false; button.textContent='‚ñ∂Ô∏è Ods≈Çuch'; return; }
    reading=true; button.textContent='‚è∏Ô∏è Pauza';
    function readNext(){
      if(!reading||i>=sentences.length){ synth.cancel(); reading=false; button.textContent='‚ñ∂Ô∏è Ods≈Çuch'; i=0; return; }
      const utter=new SpeechSynthesisUtterance(sentences[i].trim());
      utter.lang='pl-PL'; utter.onend=()=>{i++; readNext();};
      synth.speak(utter);
    }
    readNext();
  });
}

async function loadLatarnia() {
  const container = document.getElementById('entries-container');
  try {
    const sekcje=['Kronika','Opowie≈õci Aurela'];
    let html='';
    for(const sekcja of sekcje){
      const colRef=collection(db,'sekcje',sekcja,'entries');
      const snap = await getDocs(query(colRef, orderBy("createdAt","desc"), limit(3)));
      snap.docs.forEach(doc=>{
        const data=doc.data();
        const textPreview=(data.text||'').replace(/<[^>]*>?/gm,'').substring(0,250);
        const url=`wpis.html?section=${encodeURIComponent(sekcja)}&id=${doc.id}`;
        html+=`
          <div class="story-item">
            <h3>${data.title||'Bez tytu≈Çu'}</h3>
            <p id="preview-${doc.id}">${textPreview}...</p>
            <div class="button-row">
              <a href="${url}" class="read-more-button">Czytaj dalej</a>
              <button class="speak-button" id="speak-${doc.id}">‚ñ∂Ô∏è Ods≈Çuch</button>
            </div>
          </div>`;
      });
    }
    container.innerHTML=html||'<p>Brak wpis√≥w w bazie.</p>';

    sekcje.forEach(async sekcja=>{
      const colRef=collection(db,'sekcje',sekcja,'entries');
      const snap = await getDocs(query(colRef, orderBy("createdAt","desc"), limit(3)));
      snap.docs.forEach(doc=>{
        const btn=document.getElementById(`speak-${doc.id}`);
        const textEl=document.getElementById(`preview-${doc.id}`);
        if(btn && textEl) createLector(btn,textEl);
      });
    });
  } catch(e){ console.error(e); container.innerHTML='<p>B≈ÇƒÖd ≈Çadowania wpis√≥w.</p>'; }
}

loadMenu();
loadLatarnia();
</script>
</body>
</html>
